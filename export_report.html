<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Generating Excel Report...</title>
    <!-- Supabase & Tools -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <!-- ExcelJS & FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
        }
        .loader {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-container {
            width: 500px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            overflow: hidden;
            margin-top: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        .progress-bar {
            height: 12px;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            transition: width 0.5s ease;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.6);
        }
        #status {
            margin-top: 25px;
            font-size: 18px;
            color: rgba(255,255,255,0.95);
            text-align: center;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        h2 {
            font-weight: 800;
            font-size: 28px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            letter-spacing: -0.5px;
        }
    </style>
</head>
<body>

    <div class="loader"></div>
    <h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel...</h2>
    <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>
    <p id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>

    <script>
        // Config
        const SUPABASE_URL = 'https://nmezqexpvhdozpdzxxek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tZXpxZXhwdmhkb3pwZHp4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5OTAwNTEsImV4cCI6MjA4MjU2NjA1MX0.N1OjCh1sp0xx0DGFjR6yX2hix5oIX7suzrnvQk8qPWU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const monthFilter = urlParams.get('month');

        function updateStatus(msg, percent) {
            document.getElementById('status').innerText = msg;
            document.getElementById('progressBar').style.width = `${percent}%`;
        }

        async function urlToBase64(url) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.warn("Failed to load image:", url);
                return null;
            }
        }

        async function generateReport() {
            try {
                if (!monthFilter) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô Export");

                const startDate = `${monthFilter}-01`;
                const endDate = dayjs(startDate).add(1, 'month').format('YYYY-MM-DD');

                updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°...', 10);

                // 1. Fetch Tickets
                const { data: tickets, error } = await supabaseClient
                    .from('tickets')
                    .select('*')
                    .gte('incident_time', startDate)
                    .lt('incident_time', endDate)
                    .order('incident_time');

                if (error) throw error;
                if (!tickets || tickets.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ");

                // 2. Fetch Related Data (Batch)
                updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö...', 20);

                const assetIds = [...new Set(tickets.map(t => t.asset_id).filter(id => id))];
                const userIds = [...new Set(tickets.map(t => t.requester_id).filter(id => id))];
                const techIds = [...new Set(tickets.map(t => t.technician_id).filter(id => id))];
                const allUserIds = [...new Set([...userIds, ...techIds])];
                const ticketIds = tickets.map(t => t.id);

                let assetsMap = {}, profilesMap = {}, partsMap = {};

                const promises = [
                    assetIds.length ? supabaseClient.from('assets').select('id, name, location, asset_code').in('id', assetIds) : { data: [] },
                    allUserIds.length ? supabaseClient.from('profiles').select('id, full_name, username').in('id', allUserIds) : { data: [] },
                    ticketIds.length ? supabaseClient.from('spare_parts_requests').select('*').in('ticket_id', ticketIds) : { data: [] }
                ];

                const [assetsRes, profilesRes, partsRes] = await Promise.all(promises);

                assetsRes.data?.forEach(a => assetsMap[a.id] = a);
                profilesRes.data?.forEach(p => profilesMap[p.id] = p.full_name || p.username);
                partsRes.data?.forEach(p => {
                    if (!partsMap[p.ticket_id]) partsMap[p.ticket_id] = [];
                    partsMap[p.ticket_id].push(p);
                });

                // 3. Setup Excel Workbook
                updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå...', 30);
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á');

                // Set Page Setup for A4 Landscape
                worksheet.pageSetup = {
                    paperSize: 9, // A4
                    orientation: 'landscape',
                    fitToPage: true,
                    fitToWidth: 1,
                    fitToHeight: 0,
                    margins: {
                        left: 0.5, right: 0.5, top: 0.75, bottom: 0.75,
                        header: 0.3, footer: 0.3
                    }
                };

                // Define Column Widths (Thai Template Format)
                worksheet.columns = [
                    { width: 8 },   // A: ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
                    { width: 8 },   // B: ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
                    { width: 12 },  // C: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á
                    { width: 20 },  // D: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£
                    { width: 18 },  // E: ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£
                    { width: 18 },  // F: ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏
                    { width: 22 },  // G: ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà
                    { width: 15 },  // H: ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
                    { width: 6 },   // I: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                    { width: 15 },  // J: ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
                    { width: 30 }   // K: ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (ALL IMAGES)
                ];

                // HEADER SECTION (Row 1-3)
                // Row 1: Logo | Title | Date
                const row1 = worksheet.getRow(1);
                row1.height = 35;

                // Logo (Placeholder - using icon symbol)
                worksheet.getCell('A1').value = 'üè≠ WD';
                worksheet.getCell('A1').font = { size: 18, bold: true, color: { argb: 'FF0066CC' } };
                worksheet.getCell('A1').alignment = { horizontal: 'left', vertical: 'middle' };

                // Title (Centered)
                worksheet.mergeCells('B1:I1');
                const titleCell = worksheet.getCell('B1');
                titleCell.value = "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á";
                titleCell.font = { size: 18, bold: true, color: { argb: 'FF1F2937' } };
                titleCell.alignment = { horizontal: 'center', vertical: 'middle' };

                // Date (Right aligned)
                worksheet.mergeCells('J1:K1');
                const dateCell = worksheet.getCell('J1');
                dateCell.value = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dayjs().format('DD/MM/YYYY')}`;
                dateCell.font = { size: 11, bold: true };
                dateCell.alignment = { horizontal: 'right', vertical: 'middle' };

                // Row 2: Subtitle/Period
                const row2 = worksheet.getRow(2);
                row2.height = 20;
                worksheet.mergeCells('A2:K2');
                const periodCell = worksheet.getCell('A2');
                periodCell.value = `‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${dayjs(startDate).format('MMMM YYYY')} | WD Manufacturing Co., Ltd.`;
                periodCell.font = { size: 10, italic: true, color: { argb: 'FF6B7280' } };
                periodCell.alignment = { horizontal: 'center', vertical: 'middle' };

                // Row 3: Empty spacing
                worksheet.getRow(3).height = 5;

                // TABLE HEADERS (Row 4)
                const headerLabels = [
                    "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°",
                    "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à",
                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á",
                    "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå",
                    "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£",
                    "‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£",
                    "‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà",
                    "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ",
                    "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô",
                    "‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô",
                    "‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö"
                ];

                const headerRow = worksheet.addRow(headerLabels);
                headerRow.height = 35;
                headerRow.eachCell((cell) => {
                    cell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF2563EB' } // Blue header
                    };
                    cell.alignment = {
                        horizontal: 'center',
                        vertical: 'middle',
                        wrapText: true
                    };
                    cell.border = {
                        top: { style: 'medium', color: { argb: 'FF1E3A8A' } },
                        left: { style: 'thin', color: { argb: 'FF1E3A8A' } },
                        bottom: { style: 'medium', color: { argb: 'FF1E3A8A' } },
                        right: { style: 'thin', color: { argb: 'FF1E3A8A' } }
                    };
                });

                // 4. DATA ROWS WITH IMAGES
                let currentRow = 5; // Data starts at row 5

                for (let i = 0; i < tickets.length; i++) {
                    const t = tickets[i];
                    const pct = 30 + Math.round(((i + 1) / tickets.length) * 60);
                    updateStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${i + 1}/${tickets.length}...`, pct);

                    const asset = assetsMap[t.asset_id] || {};
                    const parts = partsMap[t.id] || [];

                    // Format parts list
                    const partsStr = parts.map(p => `${p.part_name}`).join('\n');
                    const qtyStr = parts.map(p => p.quantity).join('\n');
                    const partsDetail = parts.map(p => `${p.part_name} (${p.quantity})`).join(', ');

                    // Extract Data (Thai Template Format)
                    const rowData = [
                        t.incident_time ? dayjs(t.incident_time).format('HH:mm') : '-',
                        t.finished_at ? dayjs(t.finished_at).format('HH:mm') : '-',
                        asset.location || '-',
                        asset.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                        t.issue_text || '-',
                        t.description || '-',
                        (t.repair_details || '') + (partsDetail ? '\n\n‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà: ' + partsDetail : ''),
                        partsStr || '-',
                        qtyStr || '-',
                        profilesMap[t.technician_id] || '-',
                        '' // Images placeholder
                    ];

                    const row = worksheet.addRow(rowData);

                    // Style each cell
                    row.eachCell((cell, colNumber) => {
                        cell.alignment = {
                            vertical: 'top',
                            wrapText: true,
                            horizontal: colNumber <= 2 || colNumber === 9 ? 'center' : 'left'
                        };
                        cell.font = { size: 10 };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                            left: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                            bottom: { style: 'thin', color: { argb: 'FFD1D5DB' } },
                            right: { style: 'thin', color: { argb: 'FFD1D5DB' } }
                        };

                        // Alternate row colors
                        if (i % 2 === 0) {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF9FAFB' } };
                        }
                    });

                    // --- IMAGE LOGIC (ALL IMAGES IN GRID) ---
                    const { data: mediaList } = await supabaseClient.from('media').select('*').eq('ticket_id', t.id);

                    // Collect ALL Images (Before + After)
                    let allImages = [];

                    // Add cover photo
                    if (t.photo_url) {
                        allImages.push({ url: t.photo_url, type: 'BEFORE' });
                    }

                    // Add media images
                    if (mediaList && mediaList.length > 0) {
                        mediaList.forEach(m => {
                            const type = m.type === 'AFTER_IMAGE' ? 'AFTER' : 'BEFORE';
                            allImages.push({ url: m.url, type });
                        });
                    }

                    // Calculate dynamic row height based on number of images
                    const imagesPerRow = 2; // 2 images per row
                    const imageRows = Math.ceil(allImages.length / imagesPerRow);
                    const imageHeight = 80; // Height per image row
                    const dynamicHeight = Math.max(50, imageRows * imageHeight + 10);
                    row.height = dynamicHeight;

                    // Embed ALL images in grid format (Column K)
                    if (allImages.length > 0) {
                        for (let j = 0; j < allImages.length; j++) {
                            const img = allImages[j];
                            const b64 = await urlToBase64(img.url);

                            if (b64) {
                                const imgId = workbook.addImage({
                                    base64: b64,
                                    extension: 'jpeg'
                                });

                                // Calculate position in grid (2 columns)
                                const rowOffset = Math.floor(j / 2);
                                const colOffset = (j % 2) * 0.5;

                                worksheet.addImage(imgId, {
                                    tl: {
                                        col: 10 + colOffset,  // Column K (index 10)
                                        row: currentRow - 1 + (rowOffset * 0.85)
                                    },
                                    ext: { width: 110, height: 75 },
                                    editAs: 'oneCell'
                                });
                            }
                        }
                    } else {
                        // No images - add text
                        const imgCell = worksheet.getCell(`K${currentRow}`);
                        imgCell.value = '- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ -';
                        imgCell.font = { italic: true, color: { argb: 'FF9CA3AF' } };
                        imgCell.alignment = { horizontal: 'center', vertical: 'middle' };
                    }

                    currentRow++;
                }

                // 5. FOOTER (Signatures)
                currentRow += 2; // Add spacing

                // Signature Lines
                const sigRow1 = worksheet.getRow(currentRow);
                sigRow1.height = 60;

                // Three signature columns
                worksheet.mergeCells(`B${currentRow}:C${currentRow}`);
                worksheet.mergeCells(`E${currentRow}:F${currentRow}`);
                worksheet.mergeCells(`H${currentRow}:I${currentRow}`);

                currentRow++;
                const sigRow2 = worksheet.getRow(currentRow);

                worksheet.mergeCells(`B${currentRow}:C${currentRow}`);
                worksheet.getCell(`B${currentRow}`).value = '........................................';
                worksheet.getCell(`B${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`B${currentRow}`).font = { size: 10 };

                worksheet.mergeCells(`E${currentRow}:F${currentRow}`);
                worksheet.getCell(`E${currentRow}`).value = '........................................';
                worksheet.getCell(`E${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`E${currentRow}`).font = { size: 10 };

                worksheet.mergeCells(`H${currentRow}:I${currentRow}`);
                worksheet.getCell(`H${currentRow}`).value = '........................................';
                worksheet.getCell(`H${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`H${currentRow}`).font = { size: 10 };

                currentRow++;
                const sigRow3 = worksheet.getRow(currentRow);

                worksheet.mergeCells(`B${currentRow}:C${currentRow}`);
                worksheet.getCell(`B${currentRow}`).value = '‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£ (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á)';
                worksheet.getCell(`B${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`B${currentRow}`).font = { size: 10, bold: true };

                worksheet.mergeCells(`E${currentRow}:F${currentRow}`);
                worksheet.getCell(`E${currentRow}`).value = '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢)';
                worksheet.getCell(`E${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`E${currentRow}`).font = { size: 10, bold: true };

                worksheet.mergeCells(`H${currentRow}:I${currentRow}`);
                worksheet.getCell(`H${currentRow}`).value = '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô';
                worksheet.getCell(`H${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`H${currentRow}`).font = { size: 10, bold: true };

                // 6. DOWNLOAD FILE
                updateStatus('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', 100);
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                saveAs(blob, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á_${monthFilter.replace('-', '_')}.xlsx`);

                document.getElementById('status').innerHTML = '<span style="color:#4ade80; font-size: 22px;">‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</span><br><br><button onclick="window.close()" style="padding:12px 30px; cursor:pointer; background:linear-gradient(135deg, #4ade80, #22c55e); color:white; border:none; border-radius:12px; font-weight: bold; font-size: 16px; box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4); transition: all 0.3s;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>';
                document.getElementById('progressBar').style.background = 'linear-gradient(90deg, #4ade80, #22c55e)';

            } catch (err) {
                console.error(err);
                document.getElementById('status').innerHTML = `<span style="color:#fca5a5; font-size: 18px;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:<br>${err.message}</span><br><br><button onclick="window.close()" style="padding:10px 24px; cursor:pointer; background:#ef4444; color:white; border:none; border-radius:10px; font-weight: bold;">‡∏õ‡∏¥‡∏î</button>`;
                document.getElementById('progressBar').style.background = '#ef4444';
            }
        }

        generateReport();
    </script>
</body>
</html>
