<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (V51 - Gallery Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    <script>
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.locale('th'); 
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .btn-issue.selected {
            background-color: #EF4444; color: white; border-color: #EF4444;
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.5);
        }
        #reader { 
            width: 100%; height: 100%; background: #000;
        }
        .nav-item.active { color: #2563EB; font-weight: bold; }
        .nav-item.active i { transform: scale(1.2); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        @keyframes pulse-orange {
            0%, 100% { border-color: #FDBA74; background-color: #FFF7ED; }
            50% { border-color: #FB923C; background-color: #FFEDD5; }
        }
        .reject-highlight { animation: pulse-orange 2s infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center">

    <div class="w-full max-w-md bg-white shadow-xl min-h-screen relative flex flex-col">
        
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 sticky top-0 z-20 shadow-md flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-tools mr-2"></i>WD Maintenance</h1>
            <div class="flex items-center gap-2">
                <span id="statusBadge" class="text-[10px] bg-gray-700 px-2 py-1 rounded-full text-gray-300">Offline</span>
                <button onclick="logout()" class="text-white hover:text-gray-200"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <!-- CONFIG PANEL -->
        <div id="configPanel" class="bg-gray-800 p-4 m-4 rounded-xl shadow-lg text-white">
            <h3 class="font-bold text-yellow-400 mb-2">üîå ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h3>
            <input type="text" id="supaUrl" class="w-full bg-gray-700 border-none rounded p-2 mb-2 text-sm" placeholder="Project URL">
            <input type="password" id="supaKey" class="w-full bg-gray-700 border-none rounded p-2 mb-3 text-sm" placeholder="API Key">
            <div class="flex items-center mb-3">
                <input type="checkbox" id="rememberMe" checked class="mr-2">
                <label for="rememberMe" class="text-xs text-gray-300">‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</label>
            </div>
            <button onclick="connectSupabase(true)" class="w-full bg-blue-500 hover:bg-blue-600 py-2 rounded font-bold">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <!-- === PAGE 1: CREATE REQUEST === -->
        <div id="pageCreate" class="flex-grow p-4 flex flex-col hidden pb-24">
            
            <div id="browserHint" class="hidden mb-4 bg-yellow-50 border border-yellow-200 p-2 rounded text-xs text-yellow-800 flex items-center">
                <i class="fas fa-info-circle mr-2"></i> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ Opera/Firefox ‡∏´‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            </div>

            <!-- STEP 1: SCANNER -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6 overflow-hidden transition-all" id="step1">
                <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                    <h2 class="font-bold text-gray-700">1. ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h2>
                    <button onclick="openAssetModal()" class="text-xs text-blue-600 underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </div>
                <div class="p-4">
                    <div id="assetSelectorDefault">
                        <button onclick="startCamera('REPORT')" class="w-full bg-blue-100 text-blue-700 py-4 rounded-xl border border-blue-200 font-bold flex flex-col items-center justify-center hover:bg-blue-200 transition mb-3">
                            <i class="fas fa-qrcode text-3xl mb-2"></i> 
                            <span>‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</span>
                        </button>
                        
                        <div class="text-center">
                             <span class="text-xs text-gray-400">‡∏´‡∏£‡∏∑‡∏≠</span>
                        </div>

                         <div class="relative mt-2">
                            <button class="w-full bg-white border-2 border-dashed border-gray-300 text-gray-500 py-2 rounded-xl flex items-center justify-center">
                                <span class="text-xs"><i class="fas fa-image mr-1"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ QR (‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢)</span>
                            </button>
                            <input type="file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="scanFromFile(this)" onclick="this.value=null">
                        </div>
                    </div>
                    
                    <div id="assetSelectorSelected" class="hidden bg-green-50 border border-green-200 p-4 rounded-xl relative">
                         <button onclick="resetScan()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-sm"><i class="fas fa-times"></i></button>
                        <div class="mb-3">
                            <h3 class="font-bold text-gray-800 text-lg" id="resAssetName">...</h3>
                            <p class="text-sm text-gray-600" id="resAssetLoc">...</p>
                        </div>
                        
                        <!-- Status -->
                        <div id="latestStatusContainer" class="mb-3 pt-3 border-t border-green-200">
                            <p class="text-xs text-gray-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</p>
                            <div id="latestStatusText" class="flex items-center gap-2 text-sm">
                                <i class="fas fa-spinner fa-spin text-green-600"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                            </div>
                        </div>

                        <button onclick="openAssetHistoryModal()" class="w-full bg-white border border-green-300 text-green-700 py-2 rounded-lg text-sm font-bold hover:bg-green-50 flex items-center justify-center transition shadow-sm">
                             <i class="fas fa-history mr-2 text-lg"></i> ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°
                        </button>
                    </div>

                </div>
            </div>

            <!-- STEP 2: ISSUE -->
            <div id="step2" class="opacity-50 pointer-events-none transition-all duration-300 mb-6">
                <h2 class="font-bold text-gray-700 mb-2 ml-1">2. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢</h2>
                <div id="issueGrid" class="grid grid-cols-2 gap-3"></div>
            </div>

            <!-- STEP 3: PHOTO -->
            <div id="step3" class="opacity-50 pointer-events-none transition-all duration-300 mb-6">
                <div class="flex justify-between items-end mb-2 ml-1">
                    <h2 class="font-bold text-gray-700">3. ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h2>
                    <span id="evidenceCount" class="text-xs text-gray-400">0/10</span>
                </div>
                
                <div class="bg-white rounded-xl border border-gray-200 p-3 relative">
                    <div id="mediaLoading" class="hidden absolute inset-0 bg-white/95 z-20 flex flex-col items-center justify-center rounded-xl">
                        <i class="fas fa-circle-notch fa-spin text-blue-500 text-3xl mb-2"></i>
                        <p class="text-sm text-gray-700 font-bold" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå...</p>
                    </div>

                    <div class="flex items-center gap-3 overflow-x-auto pb-2 min-h-[90px]" id="evidencePreviewContainer">
                        
                        <!-- 1. ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ -->
                        <label class="flex-shrink-0 w-20 h-20 border-2 border-dashed border-blue-300 rounded-lg bg-blue-50 flex flex-col items-center justify-center text-blue-500 active:bg-blue-100 transition relative">
                            <i class="fas fa-camera text-xl"></i>
                            <span class="text-[10px] mt-1">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</span>
                            <input type="file" accept="image/*" capture="environment" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" id="cameraInput" onchange="handleEvidenceSelect(this)" onclick="this.value=null">
                        </label>

                        <!-- 2. ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏•‡∏ö‡∏±‡πâ‡∏° -->
                        <label class="flex-shrink-0 w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg bg-white flex flex-col items-center justify-center text-gray-400 active:bg-gray-100 transition relative">
                            <i class="fas fa-images text-xl"></i>
                            <span class="text-[10px] mt-1 text-center leading-tight">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ<br>‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</span>
                            <input type="file" accept="image/*,video/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" id="galleryInput" onchange="handleEvidenceSelect(this)" onclick="this.value=null">
                        </label>

                    </div>
                </div>
            </div>

            <!-- SUBMIT BUTTON -->
            <button onclick="submitTicket()" id="submitBtn" class="w-full bg-gray-300 text-gray-500 font-bold py-3 rounded-xl text-lg shadow-none cursor-not-allowed transition-all" disabled>
                ‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö...
            </button>
        </div>

        <!-- === PAGE 2: HISTORY === -->
        <div id="pageHistory" class="flex-grow p-4 flex flex-col hidden pb-24 bg-gray-50">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-gray-700 text-lg">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>
                <!-- Force Refresh Button -->
                <button onclick="fetchHistory()" class="bg-white border border-gray-300 text-blue-600 px-3 py-1 rounded-lg text-sm shadow-sm hover:bg-blue-50 active:scale-95 transition">
                    <i class="fas fa-sync-alt mr-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
            </div>

            <!-- SCAN FOR HISTORY BUTTON -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4 flex items-center justify-between shadow-sm cursor-pointer hover:bg-blue-100 transition" onclick="startCamera('HISTORY')">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                        <i class="fas fa-qrcode text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-blue-800">‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
                        <p class="text-xs text-blue-600">‡∏™‡πà‡∏≠‡∏á QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>
                    </div>
                </div>
                <i class="fas fa-chevron-right text-blue-300"></i>
            </div>

            <div id="historyList" class="space-y-3">
                <div class="text-center text-gray-400 mt-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <!-- BOTTOM NAV BAR -->
        <div id="bottomNav" class="hidden fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 shadow-lg flex justify-around p-2 z-50">
            <button onclick="switchTab('create')" id="navCreate" class="nav-item active flex-1 py-2 flex flex-col items-center text-gray-400 transition-all">
                <i class="fas fa-plus-circle text-2xl mb-1"></i>
                <span class="text-xs">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</span>
            </button>
            <button onclick="switchTab('history')" id="navHistory" class="nav-item flex-1 py-2 flex flex-col items-center text-gray-400 transition-all">
                <i class="fas fa-history text-2xl mb-1"></i>
                <span class="text-xs">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</span>
            </button>
        </div>

    </div>

    <!-- GLOBAL SCANNER -->
    <div id="scannerOverlay" class="fixed inset-0 bg-black z-[60] hidden flex flex-col">
        <div class="absolute top-4 right-4 z-20">
            <button onclick="stopCamera()" class="bg-white/20 backdrop-blur text-white rounded-full w-10 h-10 flex items-center justify-center text-xl">
                &times;
            </button>
        </div>
        <div class="flex-grow relative">
            <div id="reader" class="w-full h-full object-cover"></div>
            <div class="absolute inset-0 border-[40px] border-black/50 pointer-events-none flex items-center justify-center">
                <div class="border-2 border-white/50 w-64 h-64 rounded-lg relative">
                    <div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-blue-500"></div><div class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-blue-500"></div><div class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-blue-500"></div><div class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-blue-500"></div>
                </div>
            </div>
            <div class="absolute bottom-10 left-0 right-0 text-center text-white pointer-events-none">
                <p class="text-lg font-bold drop-shadow-md">‡∏™‡πà‡∏≠‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà QR Code</p>
                <p class="text-sm opacity-80" id="scanModeText">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</p>
            </div>
        </div>
        <div class="bg-black p-4 pb-8 flex justify-center">
             <label class="text-white flex flex-col items-center cursor-pointer opacity-80 hover:opacity-100">
                <i class="fas fa-image text-2xl mb-1"></i>
                <span class="text-xs">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ó‡∏ô</span>
                <input type="file" accept="image/*" class="hidden" onchange="scanFromFile(this)" onclick="this.value=null">
            </label>
        </div>
        <div id="camErrorOverlay" class="absolute inset-0 bg-black flex flex-col items-center justify-center text-white hidden z-30">
            <i class="fas fa-video-slash text-4xl mb-4 text-red-500"></i>
            <p class="text-lg font-bold">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å</p>
            <p class="text-sm text-gray-400 mt-2 mb-6 text-center px-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
            <button onclick="stopCamera()" class="bg-white text-black px-6 py-2 rounded-full font-bold">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <!-- ASSET HISTORY MODAL (FIXED & RICH) -->
    <div id="assetHistoryModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl h-[85vh] flex flex-col shadow-2xl animate-slide-up overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h3>
                    <p class="text-xs text-gray-500" id="assetHistoryTitle">...</p>
                </div>
                <button onclick="closeAssetHistoryModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div id="assetHistoryContent" class="flex-grow overflow-y-auto p-4 bg-gray-50 space-y-3"></div>
        </div>
    </div>

    <!-- Media Modal, Reject Modal, Asset Modal -->
    <div id="assetModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-xl shadow-2xl h-[70vh] flex flex-col"><div class="p-3 border-b flex justify-between items-center bg-gray-50 rounded-t-xl"><h3 class="font-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h3><button onclick="closeAssetModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 hover:bg-gray-300">&times;</button></div><div id="assetListContainer" class="flex-grow overflow-y-auto p-2 space-y-2"></div></div></div>
    <div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4" onclick="closeMediaModal()"><div class="relative max-w-full max-h-full" onclick="event.stopPropagation()"><img id="modalImage" class="max-w-full max-h-[80vh] rounded shadow-2xl hidden" src=""><video id="modalVideo" class="max-w-full max-h-[80vh] rounded shadow-2xl hidden" controls></video><button onclick="closeMediaModal()" class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">&times;</button></div></div>
    <div id="rejectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-5 animate-bounce-in"><h3 class="font-bold text-lg text-red-600 mb-2 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</h3><textarea id="rejectReasonInput" class="w-full border p-3 rounded-lg mb-4 focus:ring-2 focus:ring-red-500 outline-none text-sm" rows="3"></textarea><div class="flex gap-2"><button onclick="closeRejectModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="submitReject()" id="btnSubmitReject" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600 shadow">‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div></div></div>

    <script>
        let supabaseClient = null;
        let html5QrCode = null;
        let currentScanMode = 'REPORT'; 
        let isCameraBusy = false;
        
        const STATE = { currentAssetId: null, currentUserId: null, selectedIssue: null, evidenceMedia: [], allAssets: [], rejectTicketId: null, rejectTicketCount: 0 };

        window.onload = () => { 
            updateEvidencePreview();
            const ua = navigator.userAgent.toLowerCase();
            if(ua.indexOf("android") > -1) document.getElementById('browserHint').classList.remove('hidden');
            const savedUrl = localStorage.getItem('cmms_url'); const savedKey = localStorage.getItem('cmms_key');
            if(savedUrl && savedKey) { document.getElementById('supaUrl').value = savedUrl; document.getElementById('supaKey').value = savedKey; connectSupabase(false); }
        };

        async function connectSupabase(isManual = false) {
            const url = document.getElementById('supaUrl').value.trim(); const key = document.getElementById('supaKey').value.trim();
            if(!url || !key) { if(isManual) alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ Key"); return; }
            try {
                const { createClient } = supabase; supabaseClient = createClient(url, key);
                const [issuesRes, userRes, assetsRes] = await Promise.all([
                    supabaseClient.from('issue_options').select('*').eq('is_active', true).order('sort_order'),
                    supabaseClient.from('profiles').select('id').eq('username', 'somchai').single(),
                    supabaseClient.from('assets').select('*').order('name')
                ]);
                renderIssues(issuesRes.data || []);
                if(userRes.data) STATE.currentUserId = userRes.data.id;
                STATE.allAssets = assetsRes.data || [];
                renderAssetList(STATE.allAssets);
                if(document.getElementById('rememberMe').checked) { localStorage.setItem('cmms_url', url); localStorage.setItem('cmms_key', key); }
                document.getElementById('configPanel').classList.add('hidden'); document.getElementById('pageCreate').classList.remove('hidden'); document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('statusBadge').innerText = "Online"; document.getElementById('statusBadge').className = "text-xs bg-green-500 px-2 py-1 rounded-full text-white";
                fetchHistory(); // Auto load history
            } catch(e) { if(isManual) alert("Connection Error: " + e.message); }
        }

        // --- UPDATED EVIDENCE HANDLER ---
        async function handleEvidenceSelect(input) {
            if (!input.files || input.files.length === 0) return;
            const loadingEl = document.getElementById('mediaLoading');
            loadingEl.classList.remove('hidden');
            
            // Allow UI to render loading state
            await new Promise(r => setTimeout(r, 50));

            const files = Array.from(input.files);
            if (STATE.evidenceMedia.length + files.length > 10) {
                alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡πÑ‡∏ü‡∏•‡πå");
                loadingEl.classList.add('hidden'); input.value = ''; return;
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    const type = file.type.startsWith('image/') ? 'IMAGE' : 'VIDEO';
                    if (type === 'VIDEO' && file.size > 20*1024*1024) { alert(`‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô: ${file.name}`); continue; }
                    
                    const base64 = await fileToBase64(file, type);
                    if(base64) STATE.evidenceMedia.push({type, url: base64});
                } catch(err) { console.error(err); }
            }
            
            input.value = ''; 
            updateEvidencePreview();
            loadingEl.classList.add('hidden');
        }

        function fileToBase64(file, type) {
            return new Promise((resolve) => {
                if (type === 'VIDEO') {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => resolve(null);
                    reader.readAsDataURL(file);
                } else {
                    createImageBitmap(file).then(bitmap => {
                        try {
                            const cvs = document.createElement('canvas');
                            const max = 600; let w = bitmap.width; let h = bitmap.height;
                            if (w > max) { h *= max/w; w = max; } if (h > max) { w *= max/h; h = max; }
                            cvs.width = w; cvs.height = h;
                            cvs.getContext("2d").drawImage(bitmap, 0, 0, w, h);
                            resolve(cvs.toDataURL("image/jpeg", 0.5));
                        } catch (e) { fallbackFileReader(file, resolve); }
                    }).catch(() => fallbackFileReader(file, resolve));
                }
            });
        }
        function fallbackFileReader(file, resolve) {
             const reader = new FileReader();
             reader.onload = (e) => resolve(e.target.result);
             reader.onerror = () => resolve(null);
             reader.readAsDataURL(file);
        }

        function updateEvidencePreview() {
            const container = document.getElementById('evidencePreviewContainer');
            // Keep first 2 buttons
            const btnCam = container.children[0];
            const btnGal = container.children[1];
            
            // Remove old thumbnails
            while (container.children.length > 2) container.removeChild(container.lastChild);

            STATE.evidenceMedia.forEach((media, idx) => {
                const thumb = document.createElement('div');
                thumb.className = "flex-shrink-0 w-20 h-20 bg-gray-100 rounded-lg overflow-hidden border relative group";
                thumb.innerHTML = media.type === 'IMAGE' ? `<img src="${media.url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-gray-800"><i class="fas fa-video text-white"></i></div>`;
                const del = document.createElement('button');
                del.className = "absolute top-0 right-0 bg-red-500 text-white w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 z-10 rounded-bl-lg";
                del.innerHTML = "&times;";
                del.onclick = () => { STATE.evidenceMedia.splice(idx, 1); updateEvidencePreview(); };
                container.appendChild(thumb);
                thumb.appendChild(del);
            });
            document.getElementById('evidenceCount').innerText = `${STATE.evidenceMedia.length}/10`;
            
            // Check submit button
            updateSubmitBtn();
            
            if(STATE.evidenceMedia.length > 0) setTimeout(() => container.scrollTo({ left: container.scrollWidth, behavior: 'smooth' }), 100);
        }

        function removeEvidence(idx) { STATE.evidenceMedia.splice(idx, 1); updateEvidencePreview(); }

        // --- SUBMIT ---
        function updateSubmitBtn() { 
            const btn = document.getElementById('submitBtn'); 
            // Valid if Asset & Issue selected
            if(STATE.currentAssetId && STATE.selectedIssue) { 
                btn.disabled = false; 
                btn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i> ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°`; 
                btn.className = "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl text-lg shadow-lg cursor-pointer transition-all active:scale-95"; 
            } else { 
                btn.disabled = true; 
                btn.innerHTML = "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö..."; 
                btn.className = "w-full bg-gray-300 text-gray-500 font-bold py-3 rounded-xl text-lg shadow-none cursor-not-allowed"; 
            } 
        }

        async function submitTicket() { 
            const btn = document.getElementById('submitBtn'); 
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...'; 
            btn.disabled = true; 
            try { 
                const payload = { asset_id: STATE.currentAssetId, requester_id: STATE.currentUserId, issue_text: STATE.selectedIssue, status: 'OPEN', incident_time: new Date().toISOString() }; 
                const { data, error } = await supabaseClient.from('tickets').insert([payload]).select(); 
                if(error) throw error; 
                const ticketId = data[0].id; 
                for (const m of STATE.evidenceMedia) {
                     await supabaseClient.from('media').insert([{ ticket_id: ticketId, type: m.type, url: m.url }]); 
                }
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); 
                switchTab('history'); 
                resetScan(); 
                STATE.evidenceMedia=[]; 
                updateEvidencePreview(); 
            } catch(e) { 
                alert("Error: " + e.message); 
            } finally { 
                updateSubmitBtn(); 
            } 
        }

        // --- OTHER FUNCTIONS (UNCHANGED) ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('pageCreate').classList.add('hidden');
            document.getElementById('pageHistory').classList.add('hidden');
            if(tab === 'create') {
                document.getElementById('navCreate').classList.add('active');
                document.getElementById('pageCreate').classList.remove('hidden');
            } else {
                document.getElementById('navHistory').classList.add('active');
                document.getElementById('pageHistory').classList.remove('hidden');
                fetchHistory();
            }
        }
        
        function startCamera(mode = 'REPORT') {
            if(isCameraBusy) return;
            isCameraBusy = true;
            currentScanMode = mode;
            document.getElementById('scanModeText').innerText = mode === 'HISTORY' ? "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥" : "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°";
            document.getElementById('scannerOverlay').classList.remove('hidden');
            document.getElementById('camErrorOverlay').classList.add('hidden');
            if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess).catch(err => { document.getElementById('camErrorOverlay').classList.remove('hidden'); }).finally(() => isCameraBusy = false);
        }
        function stopCamera() { if(isCameraBusy) return; document.getElementById('scannerOverlay').classList.add('hidden'); if(html5QrCode) { isCameraBusy = true; html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(err => console.log(err)).finally(() => isCameraBusy = false); } }
        function scanFromFile(input) { currentScanMode = 'REPORT'; if (input.files.length === 0) return; if(!html5QrCode) html5QrCode = new Html5Qrcode("reader"); html5QrCode.scanFile(input.files[0], true).then(onScanSuccess).catch(err => alert("‡∏≠‡πà‡∏≤‡∏ô QR Code ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")); }
        function onScanSuccess(decodedText) { stopCamera(); if (currentScanMode === 'HISTORY') findAssetForHistory(decodedText); else findAsset(decodedText); }
        
        function findAsset(qrCode) { const asset = STATE.allAssets.find(a => a.qr_code === qrCode); if(asset) selectAsset(asset); else alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£!"); }
        async function findAssetForHistory(qrCode) {
            let asset = STATE.allAssets.find(a => a.qr_code === qrCode);
            if (!asset) { const { data } = await supabaseClient.from('assets').select('*').eq('qr_code', qrCode).single(); if(data) asset = data; }
            if (asset) { STATE.currentAssetId = asset.id; document.getElementById('resAssetName').innerText = asset.name; openAssetHistoryModal(); } else alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£!");
        }
        function selectAsset(asset) {
            STATE.currentAssetId = asset.id;
            document.getElementById('assetSelectorDefault').classList.add('hidden');
            document.getElementById('assetSelectorSelected').classList.remove('hidden');
            document.getElementById('resAssetName').innerText = asset.name;
            document.getElementById('resAssetLoc').innerText = asset.location;
            document.getElementById('step2').classList.remove('opacity-50', 'pointer-events-none');
            checkAssetStatus(asset.id);
            updateSubmitBtn();
        }
        function resetScan() { STATE.currentAssetId = null; document.getElementById('assetSelectorDefault').classList.remove('hidden'); document.getElementById('assetSelectorSelected').classList.add('hidden'); document.getElementById('step2').classList.add('opacity-50', 'pointer-events-none'); document.getElementById('step3').classList.add('opacity-50', 'pointer-events-none'); document.querySelectorAll('.btn-issue').forEach(b => b.classList.remove('selected', 'bg-red-500', 'text-white', 'border-red-500')); STATE.selectedIssue = null; updateSubmitBtn(); }
        async function checkAssetStatus(assetId) {
            const container = document.getElementById('latestStatusText'); container.innerHTML = 'Loading...';
            try {
                const { data } = await supabaseClient.from('tickets').select('status, issue_text').eq('asset_id', assetId).neq('status', 'CLOSED').order('created_at', { ascending: false }).limit(1).single();
                if (data) {
                    let color = 'text-red-500'; if(data.status==='IN_PROGRESS') color='text-yellow-600'; if(data.status==='PENDING_INSPECTION') color='text-blue-600';
                    container.innerHTML = `<span class="font-bold ${color}">${data.status}</span> <span class="text-xs text-gray-500">(${data.issue_text})</span>`;
                } else container.innerHTML = '<span class="text-green-600 font-bold">‡∏õ‡∏Å‡∏ï‡∏¥</span>';
            } catch (err) { container.innerHTML = '-'; }
        }
        function renderIssues(issues) { const grid = document.getElementById('issueGrid'); if(!grid) return; grid.innerHTML = ''; const allIssues = [...issues, { label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon_class: 'fa-pen' }]; allIssues.forEach(issue => { const btn = document.createElement('button'); btn.className = "btn-issue h-20 bg-white border-2 border-gray-200 rounded-xl flex flex-col items-center justify-center hover:bg-blue-50 transition"; let icon = issue.icon_class.startsWith('fa-') ? `fas ${issue.icon_class}` : 'fas fa-wrench'; btn.innerHTML = `<i class="${icon} text-2xl mb-1 text-gray-400"></i><span class="font-bold text-xs text-gray-700">${issue.label}</span>`; btn.onclick = () => selectIssue(btn, issue.label); grid.appendChild(btn); }); }
        function selectIssue(btn, text) { document.querySelectorAll('.btn-issue').forEach(b => { b.className = "btn-issue h-20 bg-white border-2 border-gray-200 rounded-xl flex flex-col items-center justify-center hover:bg-blue-50 transition"; b.querySelector('i').className = b.querySelector('i').className.replace('text-white', 'text-gray-400'); b.querySelector('span').className = "font-bold text-xs text-gray-700"; }); btn.className = "btn-issue h-20 bg-red-500 border-2 border-red-500 rounded-xl flex flex-col items-center justify-center shadow-md transform scale-105 transition"; btn.querySelector('i').className = btn.querySelector('i').className.replace('text-gray-400', 'text-white'); btn.querySelector('span').className = "font-bold text-xs text-white"; STATE.selectedIssue = text; document.getElementById('step3').classList.remove('opacity-50', 'pointer-events-none'); updateSubmitBtn(); }
        function openAssetModal() { document.getElementById('assetModal').classList.remove('hidden'); }
        function closeAssetModal() { document.getElementById('assetModal').classList.add('hidden'); }
        function renderAssetList(assets) { const c = document.getElementById('assetListContainer'); if(!c) return; c.innerHTML = ''; assets.forEach(a => { const el = document.createElement('div'); el.className = "p-3 border rounded hover:bg-gray-50 cursor-pointer flex justify-between"; el.innerHTML = `<span class="font-bold">${a.name}</span><span class="text-xs text-gray-400">${a.location}</span>`; el.onclick = () => { selectAsset(a); closeAssetModal(); }; c.appendChild(el); }); }
        async function fetchHistory() { const list = document.getElementById('historyList'); if(!list) return; list.innerHTML = 'Loading...'; try { const { data } = await supabaseClient.from('tickets').select('*, assets(name), media(*), ticket_logs(*)').eq('requester_id', STATE.currentUserId).order('incident_time', { ascending: false }); renderHistoryList(data); } catch(e) {} }
        function renderHistoryList(tickets) {
            const list = document.getElementById('historyList'); list.innerHTML='';
            if(tickets.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</div>'; return; }
            const pending = tickets.filter(t => t.status === 'PENDING_INSPECTION');
            const others = tickets.filter(t => t.status !== 'PENDING_INSPECTION');
            const sortedTickets = [...pending, ...others];
            sortedTickets.forEach(t => {
                const html = createTicketCardHTML(t);
                const wrapper = document.createElement('div'); wrapper.innerHTML = html;
                list.appendChild(wrapper.firstElementChild);
            });
        }
        function createTicketCardHTML(t) {
            const date = dayjs(t.incident_time).format('DD/MM/YY HH:mm');
            let statusBadge = ''; let actionArea = ''; let cardClass = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 transition-all";
            let rejectInfo = '';
            if(t.reject_count > 0) rejectInfo = `<span class="inline-block bg-orange-100 text-orange-600 text-[10px] px-2 py-0.5 rounded-full font-bold ml-2 border border-orange-200"><i class="fas fa-redo-alt mr-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${t.reject_count}</span>`;
            if(t.status === 'OPEN') statusBadge = '<span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</span>';
            else if(t.status === 'IN_PROGRESS') statusBadge = '<span class="bg-yellow-100 text-yellow-600 px-2 py-1 rounded text-xs font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</span>';
            else if(t.status === 'PENDING_INSPECTION') { statusBadge = '<span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-bold animate-pulse">‡∏£‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö</span>'; if(t.reject_count > 0) cardClass = "bg-orange-50 p-4 rounded-xl shadow-md border-2 border-orange-300 reject-highlight"; else cardClass = "bg-blue-50 p-4 rounded-xl shadow-md border-2 border-blue-200"; }
            else if(t.status === 'PENDING_APPROVAL') statusBadge = '<span class="bg-purple-100 text-purple-600 px-2 py-1 rounded text-xs font-bold">‡∏£‡∏≠ ‡∏ú‡∏à‡∏Å.</span>';
            else if(t.status === 'CLOSED') statusBadge = '<span class="bg-green-100 text-green-600 px-2 py-1 rounded text-xs font-bold">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</span>';
            let beforeMedia = []; let afterMedia = [];
            if(t.photo_url) beforeMedia.push({ type: 'IMAGE', url: t.photo_url, created_at: t.incident_time }); 
            if(t.media && Array.isArray(t.media)) { t.media.forEach(m => { if(m.url !== t.photo_url) { const mTime = new Date(m.created_at).getTime(); const startedTime = t.started_at ? new Date(t.started_at).getTime() : (new Date(t.incident_time).getTime() + 300000); if (mTime > startedTime) afterMedia.push(m); else beforeMedia.push(m); } }); }
            const renderMediaRow = (title, items, isLatest) => { if (items.length === 0) return ''; let html = `<p class="text-[10px] text-gray-400 font-bold mt-2 mb-1 uppercase tracking-wide border-b border-gray-100 pb-1">${title}</p><div class="flex gap-2 overflow-x-auto pb-1 hide-scroll">`; items.forEach(m => { const safeUrl = m.url.replace(/'/g, "\\'"); html += m.type === 'IMAGE' ? `<img src="${m.url}" onclick="showMedia('${safeUrl}', 'IMAGE')" class="h-16 w-16 object-cover rounded-lg border border-gray-200 flex-shrink-0 cursor-pointer shadow-sm">` : `<div onclick="showMedia('${safeUrl}', 'VIDEO')" class="h-16 w-16 bg-gray-800 rounded-lg flex items-center justify-center text-white flex-shrink-0 cursor-pointer"><i class="fas fa-video"></i></div>`; }); html += `</div>`; return html; };
            let mediaHtml = renderMediaRow('üì∏ ‡∏ï‡∏≠‡∏ô‡πÅ‡∏à‡πâ‡∏á', beforeMedia) + renderMediaRow('‚ú® ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', afterMedia);
            let repairDetailHtml = '';
            if (t.repair_details) repairDetailHtml = `<div class="mt-2 text-sm text-green-800 bg-green-50 p-3 rounded-lg border border-green-200"><i class="fas fa-tools mr-1"></i> <b>‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</b> ${t.repair_details}</div>`;
            if(t.status === 'PENDING_INSPECTION') { actionArea = `${repairDetailHtml}<div class="mt-3 pt-3 border-t border-gray-200"><p class="text-sm font-bold text-blue-700 mb-2 text-center">‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?</p><div class="flex gap-2"><button onclick="verifyTicket('${t.id}', true)" class="flex-1 bg-green-500 text-white py-3 rounded-lg text-sm font-bold shadow hover:bg-green-600 transition"><i class="fas fa-check-circle text-lg"></i> ‡∏ú‡πà‡∏≤‡∏ô</button><button onclick="openRejectModal('${t.id}', ${t.reject_count || 0})" class="flex-1 bg-white text-red-500 border border-red-300 py-3 rounded-lg text-sm font-bold hover:bg-red-50 transition"><i class="fas fa-times-circle text-lg"></i> ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</button></div></div>`; } 
            else if (t.status === 'IN_PROGRESS' && t.reject_reason) { actionArea = `<div class="mt-2 text-sm text-red-700 bg-red-50 p-2 rounded border border-red-100"><i class="fas fa-exclamation-circle"></i> <b>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</b> ${t.reject_reason}</div>`; } else { actionArea = repairDetailHtml; }
            return `<div class="${cardClass} mb-3"><div class="flex justify-between items-start mb-1"><div class="flex-1"><h3 class="font-bold text-gray-800 inline-block">${t.issue_text}</h3></div>${statusBadge}</div><p class="text-sm text-gray-500"><i class="fas fa-server mr-1"></i> ${t.assets?.name || '-'}</p><p class="text-xs text-gray-400 mt-1">${date}</p>${mediaHtml}${actionArea}</div>`;
        }
        function openAssetHistoryModal() { const assetName = document.getElementById('resAssetName').innerText; if(!STATE.currentAssetId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏Å‡πà‡∏≠‡∏ô"); document.getElementById('assetHistoryTitle').innerText = assetName; document.getElementById('assetHistoryModal').classList.remove('hidden'); fetchAssetHistory(); }
        function closeAssetHistoryModal() { document.getElementById('assetHistoryModal').classList.add('hidden'); }
        async function fetchAssetHistory() {
            const container = document.getElementById('assetHistoryContent'); container.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-spinner fa-spin"></i> ...</div>';
            try {
                const { data: tickets } = await supabaseClient.from('tickets').select(`*, profiles(full_name), media(*), ticket_logs(*)`).eq('asset_id', STATE.currentAssetId).order('incident_time', { ascending: false });
                if (!tickets || tickets.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 mt-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`; return; }
                container.innerHTML = '';
                tickets.forEach(t => { container.innerHTML += createTicketCardHTML(t); });
            } catch (err) { container.innerHTML = 'Error'; }
        }
        function showMedia(url, type) { const m = document.getElementById('mediaModal'); m.classList.remove('hidden'); const i = document.getElementById('modalImage'); const v = document.getElementById('modalVideo'); if (type === 'IMAGE') { i.src = url; i.classList.remove('hidden'); v.classList.add('hidden'); v.pause(); } else { v.src = url; v.classList.remove('hidden'); i.classList.add('hidden'); v.play(); } }
        function closeMediaModal() { document.getElementById('mediaModal').classList.add('hidden'); document.getElementById('modalVideo').pause(); }
        function openRejectModal(id, c) { STATE.rejectTicketId=id; STATE.rejectTicketCount=c; document.getElementById('rejectReasonInput').value=''; document.getElementById('rejectModal').classList.remove('hidden'); }
        function closeRejectModal() { document.getElementById('rejectModal').classList.add('hidden'); STATE.rejectTicketId=null; }
        async function verifyTicket(id, ok) { if(!ok) { openRejectModal(id,0); return; } if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?")) return; await supabaseClient.from('tickets').update({status:'PENDING_APPROVAL', verified_at: new Date().toISOString()}).eq('id',id); fetchHistory(); }
        async function submitReject() { const r = document.getElementById('rejectReasonInput').value; const newC = (STATE.rejectTicketCount||0)+1; await supabaseClient.from('tickets').update({status:'IN_PROGRESS', reject_reason:r, reject_count:newC, verified_at:null}).eq('id', STATE.rejectTicketId); await supabaseClient.from('ticket_logs').insert([{ticket_id: STATE.rejectTicketId, activity_type: 'REJECT', comment: r}]); closeRejectModal(); fetchHistory(); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>