<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>แจ้งซ่อมออนไลน์ - WD Maintenance</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    <script>
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.locale('th'); 
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .touch-card { transition: transform 0.1s; }
        .touch-card:active { transform: scale(0.96); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Media Grid */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .media-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
        .delete-btn {
            position: absolute; top: 2px; right: 2px;
            background: rgba(239, 68, 68, 0.9); color: white;
            border-radius: 50%; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; cursor: pointer;
        }
        
        /* Floating Button for History */
        .fab-history {
            position: fixed; bottom: 20px; right: 20px;
            background: #3b82f6; color: white;
            padding: 12px 20px; border-radius: 30px;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
            font-weight: bold; display: flex; align-items: center; gap: 8px;
            z-index: 40; transition: transform 0.2s;
        }
        .fab-history:active { transform: scale(0.95); }

        /* Step Circle */
        .step-circle { width: 24px; height: 24px; background: #e0f2fe; color: #0284c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; flex-shrink: 0; }
        
        .issue-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80px; transition: all 0.2s; }
        .issue-card.selected { border-color: #3b82f6; background-color: #eff6ff; color: #1d4ed8; }

        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header -->
    <header class="bg-white px-4 py-3 shadow-sm z-30 flex justify-between items-center sticky top-0 shrink-0">
        <div>
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-wrench text-blue-600"></i> แจ้งซ่อม
            </h1>
            <p class="text-xs text-gray-500" id="userDisplayName">กำลังโหลด...</p>
        </div>
        <button onclick="logout()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 pb-24 relative scroll-smooth no-scrollbar" id="mainContainer">
        
        <!-- STEP 1: ระบุเครื่องจักร -->
        <section class="mb-5">
            <div class="flex items-center gap-2 mb-2 px-1">
                <div class="step-circle">1</div>
                <h2 class="text-sm font-bold text-gray-700">ระบุเครื่องจักร</h2>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <!-- Big QR Button (Mobile Friendly) -->
                <button onclick="startScanner('ASSET')" class="w-full bg-blue-600 text-white rounded-xl py-5 shadow-lg shadow-blue-100 touch-card flex flex-col items-center justify-center gap-1 mb-3 active:bg-blue-700">
                    <i class="fas fa-qrcode text-3xl"></i>
                    <span class="text-base font-bold">สแกน QR Code</span>
                </button>

                <!-- Small Search Link -->
                <div class="text-center">
                    <button onclick="openAssetModal()" class="text-gray-500 text-xs py-2 px-4 rounded-full hover:bg-gray-50 transition flex items-center justify-center gap-2 mx-auto border border-transparent hover:border-gray-200">
                        <i class="fas fa-list"></i> เลือกจากรายการ (ค้นหาเอง)
                    </button>
                </div>

                <!-- Selected Asset Card -->
                <div id="selectedAssetCard" class="hidden mt-3 bg-blue-50 border border-blue-200 rounded-lg p-3 relative animate-pulse">
                    <button onclick="clearAsset()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 w-8 h-8 flex items-center justify-center">
                        <i class="fas fa-times-circle text-lg"></i>
                    </button>
                    <div class="pr-6">
                        <div class="text-[10px] text-blue-600 font-bold uppercase mb-1">Selected Asset</div>
                        <div class="font-bold text-gray-800 text-base leading-tight mb-1" id="assetNameDisplay">-</div>
                        <div class="flex flex-wrap gap-2 text-[10px] text-gray-500">
                            <span class="bg-white px-1.5 py-0.5 rounded border border-blue-100 font-mono" id="assetSerialDisplay">ID: -</span>
                            <span class="flex items-center gap-1"><i class="fas fa-map-marker-alt text-red-400"></i> <span id="assetLocationDisplay">-</span></span>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="assetId">
            </div>
        </section>

        <!-- STEP 2: อาการเสีย -->
        <section class="mb-5 opacity-50 pointer-events-none transition-all duration-300" id="step2">
            <div class="flex items-center gap-2 mb-2 px-1">
                <div class="step-circle">2</div>
                <h2 class="text-sm font-bold text-gray-700">อาการเสีย</h2>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="grid grid-cols-3 gap-2 mb-3" id="issueOptionsContainer">
                    <div class="col-span-3 text-center text-gray-400 py-4 text-xs">กำลังโหลด...</div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 mb-1 block">รายละเอียดเพิ่มเติม (ถ้ามี)</label>
                    <textarea id="issueDescription" rows="2" class="w-full bg-gray-50 border-0 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:bg-white transition placeholder-gray-400" placeholder="เช่น มีเสียงดัง, กลิ่นไหม้..."></textarea>
                </div>
            </div>
        </section>

        <!-- STEP 3: รูปภาพ/วิดีโอ -->
        <section class="mb-8 opacity-50 pointer-events-none transition-all duration-300" id="step3">
            <div class="flex items-center justify-between mb-2 px-1">
                <div class="flex items-center gap-2">
                    <div class="step-circle">3</div>
                    <h2 class="text-sm font-bold text-gray-700">รูปภาพ/วิดีโอ</h2>
                </div>
                <span class="text-[10px] font-bold text-gray-400" id="mediaCount">0/10</span>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-4">
                <div class="flex gap-2 mb-2">
                    <!-- ปุ่มกล้อง -->
                    <input type="file" accept="image/*" capture="environment" id="cameraInput" class="hidden" onchange="handleFileSelect(this)">
                    <label for="cameraInput" class="flex-1 bg-blue-50 border border-blue-200 text-blue-600 rounded-lg py-3 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-blue-100 active:scale-95 transition">
                        <i class="fas fa-camera text-lg"></i> <span class="text-xs font-bold">ถ่ายรูป</span>
                    </label>
                    
                    <!-- ปุ่มแกลลอรี่ -->
                    <input type="file" accept="image/*,video/*" id="galleryInput" class="hidden" multiple onchange="handleFileSelect(this)">
                    <label for="galleryInput" class="flex-1 bg-gray-50 border border-gray-200 text-gray-600 rounded-lg py-3 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-gray-100 active:scale-95 transition">
                        <i class="fas fa-images text-lg"></i> <span class="text-xs font-bold">เลือกรูป</span>
                    </label>
                </div>
                
                <div id="mediaDropZone" class="media-grid">
                    <!-- Previews -->
                </div>
            </div>

            <button onclick="submitTicket()" id="btnSubmit" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3.5 rounded-xl shadow-lg shadow-green-200 font-bold text-base touch-card flex items-center justify-center gap-2 active:scale-95 transition-all">
                <i class="fas fa-paper-plane"></i>
                <span>ส่งแจ้งซ่อม</span>
            </button>
        </section>

        <!-- Preview History Link -->
        <div class="text-center pt-2 border-t border-gray-200">
            <button onclick="openHistoryModal()" class="text-blue-500 text-xs py-2 flex items-center justify-center gap-1 mx-auto hover:underline">
                ดูประวัติการแจ้งซ่อมทั้งหมด <i class="fas fa-chevron-right text-[10px]"></i>
            </button>
        </div>

    </main>

    <!-- Floating Action Button (History) -->
    <button onclick="openHistoryModal()" class="fab-history touch-card">
        <i class="fas fa-clipboard-list text-xl"></i>
        <span>ติดตามงาน</span>
        <span id="historyBadge" class="hidden w-3 h-3 bg-red-500 rounded-full border-2 border-white absolute top-2 right-2"></span>
    </button>

    <!-- Asset Modal -->
    <div id="assetModal" class="fixed inset-0 bg-white z-50 hidden flex flex-col animate-fadeIn">
        <div class="p-4 bg-white border-b shadow-sm flex items-center gap-3 sticky top-0 z-10">
            <button onclick="closeAssetModal()" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200"><i class="fas fa-arrow-left"></i></button>
            <div class="relative flex-1">
                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                <input type="text" id="assetSearch" onkeyup="filterAssets()" placeholder="ค้นหาชื่อเครื่อง..." class="w-full pl-9 pr-4 py-2 rounded-lg border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-sm">
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="assetListContainer">
            <!-- Asset Items -->
            <div class="text-center py-10 text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i> กำลังโหลดข้อมูล...</div>
        </div>
    </div>

    <!-- History Modal (With QR Search) -->
    <div id="historyModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-gray-100 w-full sm:w-[480px] h-[90vh] sm:h-[85vh] sm:rounded-2xl rounded-t-3xl flex flex-col shadow-2xl transform transition-transform duration-300 translate-y-full" id="historyModalContent">
            
            <!-- Header -->
            <div class="bg-white p-4 rounded-t-3xl border-b border-gray-200 sticky top-0 z-10 flex justify-between items-center shadow-sm">
                <div>
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2"><i class="fas fa-history text-blue-600"></i> ติดตามสถานะงาน</h3>
                </div>
                <button onclick="closeHistoryModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fas fa-times"></i></button>
            </div>

            <!-- Search & QR -->
            <div class="bg-white px-4 py-3 border-b border-gray-200 flex gap-2">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                    <input type="text" id="historySearchInput" onkeyup="filterHistory()" placeholder="ค้นหา Ticket ID, ชื่องาน..." class="w-full bg-gray-100 border-0 rounded-lg pl-9 pr-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button onclick="startScanner('HISTORY')" class="bg-blue-600 text-white w-10 rounded-lg flex items-center justify-center shadow-sm active:scale-95 transition"><i class="fas fa-qrcode"></i></button>
            </div>

            <div class="overflow-y-auto p-4 flex-1 pb-safe" id="historyListContainer">
                <div class="flex flex-col items-center justify-center h-64 text-gray-400"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p class="text-xs">กำลังโหลด...</p></div>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal (Lightbox) -->
    <div id="imageViewerModal" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center touch-none" onclick="closeImageViewer()">
        <button class="absolute top-4 right-4 text-white/80 hover:text-white text-3xl p-2 z-10">&times;</button>
        <img id="fullImage" class="max-w-full max-h-full object-contain p-2 transition-transform duration-200" src="" alt="Full size">
    </div>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
        <div class="flex justify-between items-center p-4 pt-safe bg-black/80 text-white backdrop-blur-md absolute top-0 w-full z-10">
            <span class="font-bold text-lg"><i class="fas fa-qrcode mr-2"></i>สแกน QR</span>
            <button onclick="stopScanner()" class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/30"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 flex items-center justify-center bg-black relative">
            <div id="reader" class="w-full h-full"></div>
            <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
                <div class="w-64 h-64 border-4 border-blue-500 rounded-2xl relative shadow-[0_0_50px_rgba(59,130,246,0.5)]">
                    <div class="absolute inset-0 animate-pulse bg-blue-500/10"></div>
                </div>
            </div>
        </div>
        <div class="p-6 pb-10 bg-black text-center text-white">
            <p class="text-gray-300 text-sm" id="scannerInstruction">ส่อง QR Code ที่ติดอยู่กับเครื่องจักร</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-[60] hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="loader mb-4"></div>
        <p class="text-gray-800 font-bold text-sm animate-pulse">กำลังบันทึก...</p>
    </div>

    <script>
        const SUPABASE_URL = 'https://nmezqexpvhdozpdzxxek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tZXpxZXhwdmhkb3pwZHp4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5OTAwNTEsImV4cCI6MjA4MjU2NjA1MX0.N1OjCh1sp0xx0DGFjR6yX2hix5oIX7suzrnvQk8qPWU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let html5QrCode = null;
        let allAssets = [];
        let selectedIssue = null;
        let mediaList = [];
        let ticketsCache = [];
        let scannerMode = 'ASSET';

        // --- SAFE REDIRECT ---
        function safeRedirect(url) {
            try {
                window.location.href = url;
            } catch (e) {
                console.error(e);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            let sessionStr = localStorage.getItem('cmms_user_session');
            
            // --- SYNC REAL USER (Fix for Database Reset) ---
            if (!sessionStr) {
                // Try fetching 'user' (Created from SQL Reset)
                const { data: realUser } = await supabaseClient.from('profiles').select('*').eq('username', 'user').single();
                if(realUser) {
                    console.log("Auto-Sync: Found real user", realUser.id);
                    localStorage.setItem('cmms_user_session', JSON.stringify(realUser));
                    sessionStr = JSON.stringify(realUser);
                    
                    const t = document.createElement('div'); t.className='fixed top-4 right-4 bg-green-100 text-green-800 px-2 py-1 z-50 text-[10px] rounded shadow'; t.innerText='Sync: User Connected'; document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
                } else {
                     // Fallback
                    const dummyUser = { id: 'd3b94ecb-b0b8-4626-817a-8771fca90def', username: 'user', full_name: 'สมชาย (User)', role: 'user' };
                    localStorage.setItem('cmms_user_session', JSON.stringify(dummyUser));
                    sessionStr = JSON.stringify(dummyUser);
                }
            }
            
            if (!sessionStr) { safeRedirect('index.html'); return; }
            currentUser = JSON.parse(sessionStr);
            document.getElementById('userDisplayName').innerText = currentUser.full_name || currentUser.username;

            setTimeout(() => {
               const historyContent = document.getElementById('historyModalContent');
               if(historyContent) historyContent.classList.remove('translate-y-full');
            }, 100);

            await Promise.all([fetchAssets(), fetchIssueOptions(), fetchHistory()]);
        });

        async function fetchAssets() {
            try {
                // Updated query: Filter by 'active' (lowercase) to match default sql
                const { data, error } = await supabaseClient
                    .from('assets')
                    .select('*')
                    .or('status.eq.active,status.eq.ACTIVE'); // Handle both cases
                
                if (error) {
                    console.error("Asset Fetch Error:", error);
                    return;
                }
                
                allAssets = data || [];
            } catch(e) {
                console.error("Fetch Exception:", e);
            }
        }

        async function fetchIssueOptions() {
            try {
                const { data } = await supabaseClient.from('issue_options').select('*').eq('is_active', true).order('sort_order');
                const container = document.getElementById('issueOptionsContainer');
                container.innerHTML = '';
                let options = data || [];
                if (options.length === 0) options = [{label:'เครื่องไม่ทำงาน',icon_class:'fa-power-off'},{label:'อื่นๆ',icon_class:'fa-question'}];
                
                options.forEach(opt => {
                    const btn = document.createElement('div');
                    btn.className = 'issue-card bg-white cursor-pointer active:scale-95 touch-card';
                    btn.onclick = () => selectIssue(btn, opt.label);
                    btn.innerHTML = `<div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center mb-0.5"><i class="fas ${opt.icon_class} text-lg text-gray-400"></i></div><span class="text-xs font-bold text-gray-600 text-center leading-tight">${opt.label}</span>`;
                    container.appendChild(btn);
                });
            } catch (e) {
                console.log("Issue options error", e);
            }
        }

        async function fetchHistory() {
            const list = document.getElementById('historyListContainer');
            const mainList = document.getElementById('historyListMain');
            
            try {
                // 1. Fetch Tickets
                const { data: tickets, error } = await supabaseClient.from('tickets').select('*').eq('requester_id', currentUser.id).order('incident_time', { ascending: false });
                if (error) throw error;
                if (!tickets || tickets.length === 0) {
                    if(list) list.innerHTML = '<div class="text-center py-20 opacity-50"><i class="fas fa-history text-4xl text-gray-300 mb-2"></i><br><span class="text-xs text-gray-500">ไม่มีประวัติการแจ้งซ่อม</span></div>';
                    if(mainList) mainList.innerHTML = '<div class="text-center text-gray-400 text-xs">ไม่มีรายการ</div>';
                    return;
                }

                // 2. Manual Join (Assets & Media)
                const assetIds = [...new Set(tickets.map(t => t.asset_id).filter(id => id))];
                const ticketIds = tickets.map(t => t.id);

                let assetsMap = {}, mediaMap = {};
                if(assetIds.length>0) { const {data:a} = await supabaseClient.from('assets').select('id,name').in('id',assetIds); if(a) a.forEach(x=>assetsMap[x.id]=x); }
                if(ticketIds.length>0) { const {data:m} = await supabaseClient.from('media').select('*').in('ticket_id',ticketIds); if(m) m.forEach(x=>{if(!mediaMap[x.ticket_id]) mediaMap[x.ticket_id]=[]; mediaMap[x.ticket_id].push(x);}); }

                ticketsCache = tickets.map(t => ({
                    ...t,
                    assets: assetsMap[t.asset_id] || { name: 'Unknown Machine' },
                    media: mediaMap[t.id] || []
                }));

                renderHistoryList(ticketsCache);

            } catch(e) { 
                console.error(e);
                const errHtml = `<div class="text-center text-red-500 mt-10 text-sm">โหลดไม่สำเร็จ: ${e.message}</div>`;
                if(list) list.innerHTML = errHtml;
            }
        }

        function renderHistoryList(data) {
            const list = document.getElementById('historyListContainer');
            
            const createItemHtml = (t) => {
                let statusBadge='', statusBg='', iconStatus='';
                switch(t.status) {
                    case 'OPEN': statusBadge='รอรับงาน'; statusBg='bg-red-50 text-red-600 border border-red-100'; iconStatus='fa-hourglass-start'; break;
                    case 'IN_PROGRESS': statusBadge='กำลังซ่อม'; statusBg='bg-blue-50 text-blue-600 border border-blue-100'; iconStatus='fa-tools'; break;
                    case 'PENDING_APPROVAL': statusBadge='รออะไหล่'; statusBg='bg-orange-50 text-orange-600 border border-orange-100'; iconStatus='fa-box-open'; break;
                    case 'PENDING_INSPECTION': statusBadge='รอตรวจ'; statusBg='bg-purple-50 text-purple-600 border border-purple-100'; iconStatus='fa-clipboard-check'; break;
                    case 'CLOSED': statusBadge='เสร็จสิ้น'; statusBg='bg-green-50 text-green-600 border border-green-100'; iconStatus='fa-check-circle'; break;
                    default: statusBadge=t.status; statusBg='bg-gray-50 text-gray-600 border border-gray-200'; iconStatus='fa-info-circle';
                }
                const timeStr = t.incident_time ? dayjs(t.incident_time).format('D MMM HH:mm') : '-';
                
                let photoUrl = t.photo_url;
                if (!photoUrl && t.media.length > 0) { const img = t.media.find(m => m.type === 'IMAGE'); if(img) photoUrl = img.url; }
                
                const imgHtml = photoUrl 
                    ? `<div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-200 shrink-0 border border-gray-300 relative group cursor-pointer" onclick="viewImage('${t.id}')"><img src="${photoUrl}" class="w-full h-full object-cover"></div>`
                    : `<div class="w-16 h-16 rounded-lg bg-gray-100 shrink-0 flex items-center justify-center text-gray-300 border border-gray-200"><i class="fas ${iconStatus} text-xl"></i></div>`;

                return `<div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm mb-3 flex gap-3 items-start">${imgHtml}<div class="flex-1 min-w-0"><div class="flex justify-between items-start mb-1"><h4 class="font-bold text-gray-800 text-sm truncate pr-2">${t.assets.name}</h4><span class="${statusBg} px-2 py-0.5 rounded-full text-[10px] font-bold whitespace-nowrap">${statusBadge}</span></div><div class="text-xs text-gray-600 line-clamp-1 mb-1">${t.issue_text}</div><div class="text-[10px] text-gray-400 font-medium"><i class="far fa-clock mr-1"></i> ${timeStr} • ID: ${t.id.substring(0,4)}</div></div></div>`;
            };

            if(list) list.innerHTML = data.map(createItemHtml).join('');
        }

        function filterHistory() {
            const term = document.getElementById('historySearchInput').value.toLowerCase();
            const filtered = ticketsCache.filter(t => t.id.toLowerCase().includes(term) || t.assets.name.toLowerCase().includes(term) || t.issue_text.toLowerCase().includes(term));
            renderHistoryList(filtered);
        }

        function viewImage(id) {
            const ticket = ticketsCache.find(t => t.id === id);
            let url = ticket?.photo_url;
            if(!url && ticket?.media?.length > 0) url = ticket.media.find(m=>m.type==='IMAGE')?.url;
            if(url) { document.getElementById('fullImage').src = url; document.getElementById('imageViewerModal').classList.remove('hidden'); }
        }
        function closeImageViewer() { document.getElementById('imageViewerModal').classList.add('hidden'); }

        // --- MODALS ---
        function openHistoryModal() { document.getElementById('historyModal').classList.remove('hidden'); setTimeout(() => { document.getElementById('historyModalContent').classList.remove('translate-y-full'); }, 10); fetchHistory(); }
        function closeHistoryModal() { document.getElementById('historyModalContent').classList.add('translate-y-full'); setTimeout(() => { document.getElementById('historyModal').classList.add('hidden'); }, 300); }
        
        function openAssetModal() { 
            const c = document.getElementById('assetListContainer'); 
            c.innerHTML=''; 
            
            if (allAssets.length === 0) {
                 c.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ไม่พบรายการเครื่องจักร</div>';
            } else {
                allAssets.forEach(a => { 
                    const div = document.createElement('div'); 
                    div.className='p-4 border-b border-gray-100 hover:bg-blue-50 active:bg-blue-100 cursor-pointer transition flex justify-between items-center'; 
                    div.onclick=()=>confirmAsset(a); 
                    // Use asset_code instead of serial_number
                    div.innerHTML=`<div><div class="font-bold text-gray-800 text-sm">${a.name}</div><div class="text-xs text-gray-400 font-mono mt-0.5">ID: ${a.asset_code||'-'}</div></div><div class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-500">${a.location||'-'}</div>`; 
                    c.appendChild(div); 
                });
            }
            document.getElementById('assetModal').classList.remove('hidden'); 
        }
        function closeAssetModal() { document.getElementById('assetModal').classList.add('hidden'); }
        function filterAssets() { const t=document.getElementById('assetSearch').value.toLowerCase(); Array.from(document.getElementById('assetListContainer').children).forEach(el=>{ el.style.display=el.innerText.toLowerCase().includes(t)?'flex':'none'; }); }
        
        function confirmAsset(asset) {
            document.getElementById('assetId').value = asset.id;
            document.getElementById('assetNameDisplay').innerText = asset.name;
            document.getElementById('assetSerialDisplay').innerText = `ID: ${asset.asset_code || '-'}`;
            document.getElementById('assetLocationDisplay').innerText = asset.location || '-';
            const card = document.getElementById('selectedAssetCard');
            card.classList.remove('hidden'); card.classList.remove('animate-pulse'); void card.offsetWidth; card.classList.add('animate-pulse'); setTimeout(()=>card.classList.remove('animate-pulse'),500);
            closeAssetModal(); stopScanner();
            document.getElementById('step2').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('step3').classList.remove('opacity-50', 'pointer-events-none');
            setTimeout(()=>document.getElementById('step2').scrollIntoView({behavior:'smooth',block:'start'}),300);
        }
        function clearAsset() { document.getElementById('assetId').value = ''; document.getElementById('selectedAssetCard').classList.add('hidden'); document.getElementById('step2').classList.add('opacity-50', 'pointer-events-none'); document.getElementById('step3').classList.add('opacity-50', 'pointer-events-none'); }

        // --- SCANNER ---
        function startScanner(mode = 'ASSET') {
            scannerMode = mode;
            document.getElementById('scannerModal').classList.remove('hidden');
            document.getElementById('scannerInstruction').innerText = mode === 'ASSET' ? 'ส่อง QR Code ที่เครื่องจักร' : 'ส่อง QR Code เพื่อค้นหาประวัติ';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:{width:250,height:250}}, (txt) => {
                if (scannerMode === 'ASSET') {
                    // Check by ID or Asset Code
                    let found = allAssets.find(a => a.id == txt || a.asset_code == txt || txt.includes(a.id));
                    if(found) { confirmAsset(found); stopScanner(); } else { if(navigator.vibrate) navigator.vibrate(200); alert("ไม่พบข้อมูล: "+txt); }
                } else {
                    let asset = allAssets.find(a => a.id == txt || a.asset_code == txt || txt.includes(a.id));
                    let searchTerm = asset ? asset.name : txt;
                    document.getElementById('historySearchInput').value = searchTerm;
                    filterHistory(); stopScanner(); if(navigator.vibrate) navigator.vibrate(200);
                }
            }, (err)=>{}).catch(err=>console.log(err));
        }
        function stopScanner() { if(html5QrCode){ html5QrCode.stop().then(()=>{document.getElementById('scannerModal').classList.add('hidden'); html5QrCode.clear();}); } else { document.getElementById('scannerModal').classList.add('hidden'); } }

        function selectIssue(el, label) { selectedIssue = label; document.querySelectorAll('.issue-card').forEach(c => { c.classList.remove('selected'); c.querySelector('i').classList.replace('text-blue-500', 'text-gray-400'); }); el.classList.add('selected'); el.querySelector('i').classList.replace('text-gray-400', 'text-blue-500'); setTimeout(()=>document.getElementById('step3').scrollIntoView({behavior:'smooth',block:'center'}),300); }

        async function handleFileSelect(input) { if(mediaList.length+input.files.length>10) return alert("สูงสุด 10 ไฟล์"); document.getElementById('loadingOverlay').classList.remove('hidden'); for(const f of input.files){ try{ if(f.type.startsWith('image/')) mediaList.push({type:'IMAGE',data:await compressImage(f)}); else if(f.type.startsWith('video/')) mediaList.push({type:'VIDEO',data:await processVideo(f)}); }catch(e){alert(e)} } renderMedia(); document.getElementById('loadingOverlay').classList.add('hidden'); input.value=''; }
        function renderMedia() { const z=document.getElementById('mediaDropZone'); z.innerHTML=''; mediaList.forEach((m,i)=>{ const d=document.createElement('div'); d.className='media-item'; d.innerHTML=m.type==='IMAGE'?`<img src="${m.data}">`:`<video src="${m.data}"></video><div class="video-indicator">VIDEO</div>`; d.innerHTML+=`<div class="delete-btn" onclick="removeMedia(${i})">&times;</div>`; z.appendChild(d); }); document.getElementById('mediaCount').innerText=mediaList.length+'/10'; }
        function removeMedia(i) { mediaList.splice(i,1); renderMedia(); }
        function compressImage(f){return new Promise(r=>{const rd=new FileReader();rd.readAsDataURL(f);rd.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas');const m=800;let w=i.width,h=i.height;if(w>h&&w>m){h*=m/w;w=m}else if(h>m){w*=m/h;h=m}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);r(c.toDataURL('image/jpeg',0.7))}}})}
        function processVideo(f){return new Promise((r,j)=>{const v=document.createElement('video');v.preload='metadata';v.onloadedmetadata=()=>{window.URL.revokeObjectURL(v.src);if(v.duration>15)j("Video max 15s");else if(f.size>20*1024*1024)j("Video too large");else{const rd=new FileReader();rd.readAsDataURL(f);rd.onload=e=>r(e.target.result)}};v.src=URL.createObjectURL(f)})}

        async function submitTicket() {
            const assetId = document.getElementById('assetId').value;
            const desc = document.getElementById('issueDescription').value;
            if(!assetId) return alert("กรุณาเลือกเครื่องจักร");
            if(!selectedIssue) return alert("กรุณาเลือกอาการเสีย");

            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const cover = mediaList.find(m=>m.type==='IMAGE')?.data || null;
                const { data, error } = await supabaseClient.from('tickets').insert([{ asset_id: assetId, requester_id: currentUser.id, issue_text: selectedIssue, description: desc, photo_url: cover, status: 'OPEN', incident_time: new Date().toISOString() }]).select();
                if(error) throw error;
                const tid = data[0].id;
                if(mediaList.length>0) { const rows=mediaList.map(m=>({ticket_id:tid, type:m.type, url:m.data})); await supabaseClient.from('media').insert(rows); }
                alert("✅ ส่งแจ้งซ่อมเรียบร้อย!"); clearAsset(); selectedIssue=null; document.getElementById('issueDescription').value=''; mediaList=[]; renderMedia(); document.querySelectorAll('.issue-card').forEach(c => {c.classList.remove('selected');c.querySelector('i').classList.replace('text-blue-500', 'text-gray-400');}); document.getElementById('mainContainer').scrollTop=0; await fetchHistory(); openHistoryModal();
            } catch(e) { alert("Error: "+e.message); } finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
        }

        function logout() { localStorage.removeItem('cmms_user_session'); safeRedirect('index.html'); }
    </script>
</body>
</html>