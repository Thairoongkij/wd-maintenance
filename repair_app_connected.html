<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>แจ้งซ่อมออนไลน์ - WD Maintenance</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>

    <script>
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.locale('th'); 
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #fff9f9; }
        
        /* --- FUN RED & YELLOW THEME --- */
        .header-gradient { background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); }
        .btn-gradient-scan { background: linear-gradient(135deg, #facc15 0%, #eab308 100%); }
        .btn-gradient-submit { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .text-theme-primary { color: #dc2626; }
        .text-theme-secondary { color: #ca8a04; }
        
        .touch-card { transition: transform 0.1s; cursor: pointer; }
        .touch-card:active { transform: scale(0.96); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Media Grid */
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; margin-top: 10px; }
        .media-item { position: relative; aspect-ratio: 1; border-radius: 12px; overflow: hidden; border: 2px solid white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .media-item img { width: 100%; height: 100%; object-fit: cover; }
        .delete-btn { position: absolute; top: 4px; right: 4px; background: rgba(239, 68, 68, 0.9); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: 2px solid white; }
        
        /* Floating History Button */
        .fab-history { position: fixed; bottom: 24px; right: 24px; background: #ef4444; color: white; padding: 14px 24px; border-radius: 50px; box-shadow: 0 10px 25px -5px rgba(239, 68, 68, 0.5); font-weight: bold; display: flex; align-items: center; gap: 10px; z-index: 40; transition: all 0.2s; border: 2px solid rgba(255,255,255,0.3); }
        .fab-history:active { transform: scale(0.95); }
        
        /* Step Indicators */
        .step-badge { width: 30px; height: 30px; background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; flex-shrink: 0; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3); border: 2px solid white; }
        
        /* Cards */
        .modern-card { background: white; border-radius: 24px; box-shadow: 0 15px 35px -5px rgba(239, 68, 68, 0.1); border: 1px solid rgba(255,255,255,0.8); }
        
        .issue-card { border: 2px solid #fff1f2; border-radius: 16px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90px; transition: all 0.2s; background: #fff; position: relative; }
        .issue-card:active { transform: scale(0.95); }
        .issue-card.selected { border-color: #ef4444; background-color: #fef2f2; color: #b91c1c; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); }
        .issue-card i { transition: color 0.2s; }
        .issue-card.selected i { color: #ef4444 !important; }
        
        /* Priority Styles */
        .priority-btn { border: 2px solid #f3f4f6; border-radius: 16px; padding: 10px; text-align: center; font-size: 12px; font-weight: bold; color: #64748b; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; background: white; }
        .priority-btn.active-normal { background-color: #ecfdf5; color: #059669; border-color: #34d399; box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.2); } 
        .priority-btn.active-urgent { background-color: #fffbeb; color: #d97706; border-color: #fb923c; box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.2); } 
        .priority-btn.active-emergency { background-color: #fef2f2; color: #ef4444; border-color: #f87171; box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2); } 

        /* Toast */
        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 12px 16px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out; pointer-events: auto; border: 1px solid rgba(0,0,0,0.05); }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 bg-[#fff1f2]">

    <!-- Toast -->
    <div id="toast-container"></div>

    <!-- Header -->
    <header class="header-gradient px-6 py-6 shadow-xl shadow-red-200/50 z-30 flex justify-between items-center sticky top-0 shrink-0 text-white rounded-b-[30px] mx-[-2px]">
        <div class="flex items-center gap-3">
            <button onclick="confirmReset()" class="w-11 h-11 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30 transition backdrop-blur-md shadow-inner border-2 border-white/20 active:scale-95">
                <i class="fas fa-home text-white"></i>
            </button>
            <div>
                <h1 class="text-2xl font-black flex items-center gap-2 drop-shadow-md tracking-tight leading-none italic">แจ้งซ่อม <i class="fas fa-bolt text-yellow-300 animate-pulse"></i></h1>
                <p class="text-xs font-bold opacity-90 mt-1 ml-1 bg-black/20 inline-block px-3 py-0.5 rounded-full backdrop-blur-sm border border-white/20" id="userDisplayName">User</p>
            </div>
        </div>
        <button onclick="handleLogout()" class="px-4 py-2 rounded-2xl bg-white/20 border border-white/20 flex items-center gap-2 hover:bg-white/30 transition active:scale-95 shadow-sm">
            <span class="text-xs font-bold">ออก</span>
            <i class="fas fa-sign-out-alt text-sm"></i>
        </button>
    </header>

    <main class="flex-1 overflow-y-auto p-5 pb-32 relative scroll-smooth no-scrollbar" id="mainContainer">
        
        <!-- Decoration -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0 opacity-50">
            <div class="absolute top-[-50px] right-[-50px] w-64 h-64 bg-orange-300 rounded-full blur-[80px] mix-blend-multiply"></div>
            <div class="absolute top-[200px] left-[-50px] w-52 h-52 bg-red-300 rounded-full blur-[80px] mix-blend-multiply"></div>
            <div class="absolute bottom-[-20px] right-[20px] w-40 h-40 bg-yellow-200 rounded-full blur-[60px] mix-blend-multiply"></div>
        </div>

        <div class="relative z-10 space-y-6">
            <!-- STEP 1: ASSET -->
            <section>
                <div class="flex items-center gap-3 mb-4 px-2">
                    <div class="step-badge">1</div>
                    <h2 class="text-xl font-bold text-slate-800">ระบุรายการแจ้งซ่อม</h2>
                </div>
                
                <div class="modern-card p-6 border-t-8 border-[#facc15]">
                    <button onclick="startScanner('ASSET')" class="w-full btn-gradient-scan text-white rounded-3xl py-6 shadow-xl shadow-yellow-200 touch-card flex flex-col items-center justify-center gap-2 mb-5 active:scale-95 transition relative overflow-hidden group border-b-8 border-[#ca8a04]">
                        <div class="absolute inset-0 bg-white/20 group-hover:bg-white/30 transition"></div>
                        <i class="fas fa-qrcode text-4xl drop-shadow-md text-white animate-bounce"></i>
                        <span class="text-base font-extrabold tracking-widest text-white uppercase">สแกน QR Code</span>
                    </button>
                    
                    <div class="text-center mb-2">
                        <button onclick="openAssetModal()" class="text-slate-500 text-xs font-bold py-3 px-8 rounded-full bg-slate-100 hover:bg-white transition flex items-center justify-center gap-2 mx-auto border-2 border-slate-200 shadow-sm active:scale-95 hover:text-purple-600 hover:border-purple-200">
                            <i class="fas fa-list"></i> หรือ เลือกจากรายการ
                        </button>
                    </div>

                    <div id="selectedAssetCard" class="hidden bg-gradient-to-br from-yellow-50 to-white border-2 border-yellow-200 rounded-3xl p-5 relative animate-fadeIn shadow-lg mt-5">
                        <button onclick="clearAsset()" class="absolute top-3 right-3 text-slate-400 hover:text-red-500 bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-md transition active:scale-90 border border-slate-100 z-10">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                        <div class="pr-8">
                            <div class="text-[10px] font-bold text-yellow-600 uppercase tracking-wider mb-2 bg-yellow-100 inline-block px-3 py-1 rounded-lg">Selected</div>
                            <div class="font-extrabold text-gray-800 text-xl leading-tight mb-2" id="assetNameDisplay">-</div>
                            <div class="flex flex-wrap gap-2 text-[11px] font-medium text-slate-500">
                                <span class="bg-white px-3 py-1.5 rounded-xl border border-yellow-100 font-mono text-yellow-600 shadow-sm"><i class="fas fa-tag mr-1"></i> <span id="assetSerialDisplay">-</span></span>
                                <span class="bg-white px-3 py-1.5 rounded-xl border border-yellow-100 shadow-sm"><i class="fas fa-map-marker-alt text-red-400 mr-1"></i> <span id="assetLocationDisplay">-</span></span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="assetId">

                    <div class="relative mt-8 pt-6 border-t-2 border-dashed border-slate-200">
                        <div class="absolute top-[-14px] left-1/2 transform -translate-x-1/2 bg-white px-4 py-1 text-xs text-slate-400 font-bold uppercase tracking-widest rounded-full border border-slate-200 shadow-sm">Manual</div>
                        <label class="text-xs font-bold text-slate-500 block mb-3 mt-2 flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><i class="fas fa-pen text-xs"></i></div> ซ่อมทั่วไป (ไม่มี QR)</label>
                        <input type="text" id="manualAssetInput" oninput="handleManualInput(this)" class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-orange-100 focus:border-orange-400 focus:bg-white outline-none transition placeholder-slate-400 font-bold text-slate-700" placeholder="พิมพ์ชื่ออุปกรณ์ที่นี่...">
                        <div id="manualLocationField" class="hidden mt-3 animate-fadeIn">
                             <input type="text" id="manualLocationInput" class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-orange-100 focus:border-orange-400 focus:bg-white outline-none transition placeholder-slate-400 font-medium" placeholder="ระบุสถานที่ (ชั้น/ห้อง/บริเวณ)...">
                        </div>
                    </div>
                </div>
            </section>

            <!-- STEP 2: ISSUE -->
            <section class="opacity-50 pointer-events-none transition-all duration-500" id="step2">
                <div class="flex items-center gap-3 mb-4 px-2">
                    <div class="step-badge">2</div>
                    <h2 class="text-xl font-bold text-slate-800">รายละเอียดอาการ</h2>
                </div>
                
                <div class="modern-card p-6 space-y-6 border-l-8 border-l-[#ec4899]">
                    <div>
                        <label class="text-xs font-bold text-slate-400 mb-3 block uppercase tracking-wide flex items-center gap-2"><i class="fas fa-fire text-red-500 animate-pulse"></i> ความเร่งด่วน</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button type="button" onclick="setPriority('normal')" id="prio-normal" class="priority-btn active-normal"><i class="fas fa-smile text-3xl mb-2"></i> ปกติ</button>
                            <button type="button" onclick="setPriority('urgent')" id="prio-urgent" class="priority-btn"><i class="fas fa-exclamation-circle text-3xl mb-2"></i> ด่วน</button>
                            <button type="button" onclick="setPriority('emergency')" id="prio-emergency" class="priority-btn"><i class="fas fa-radiation-alt text-3xl mb-2 animate-spin-slow"></i> ด่วนที่สุด</button>
                        </div>
                        <input type="hidden" id="priorityInput" value="ปกติ">
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 mb-3 block uppercase tracking-wide">อาการที่พบ</label>
                        <div class="grid grid-cols-3 gap-3" id="issueOptionsContainer">
                            <div class="col-span-3 text-center text-slate-400 py-4 text-xs">Loading...</div>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 mb-3 block uppercase tracking-wide">เพิ่มเติม & ติดต่อ</label>
                        <textarea id="issueDescription" rows="2" class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-pink-100 focus:border-pink-400 focus:bg-white transition placeholder-slate-400 mb-4 font-medium text-slate-700" placeholder="มีอะไรเพิ่มเติมบอกช่างได้เลย..."></textarea>
                        <div class="relative">
                            <div class="absolute left-4 top-3.5 w-9 h-9 bg-green-100 rounded-full flex items-center justify-center text-green-600 shadow-sm"><i class="fas fa-phone-alt text-xs"></i></div>
                            <input type="tel" id="contactNumber" class="w-full bg-slate-50 border-2 border-slate-200 rounded-full pl-16 pr-6 py-4 text-sm focus:ring-4 focus:ring-green-100 focus:border-green-400 focus:bg-white transition placeholder-slate-400 font-bold text-slate-700" placeholder="เบอร์โทรติดต่อกลับ">
                        </div>
                    </div>
                </div>
            </section>

            <!-- STEP 3: PHOTO & SUBMIT -->
            <section class="opacity-50 pointer-events-none transition-all duration-500 pb-8" id="step3">
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-3">
                        <div class="step-badge">3</div>
                        <h2 class="text-xl font-bold text-slate-800">รูปภาพประกอบ</h2>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500 bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm" id="mediaCount">0/5</span>
                </div>
                
                <div class="modern-card p-6 mb-8 border-b-8 border-[#10b981]">
                    <div class="flex gap-4 mb-5">
                        <input type="file" accept="image/*" capture="environment" id="cameraInput" class="hidden" onchange="handleFileSelect(this)">
                        <label for="cameraInput" class="flex-1 bg-cyan-50 border-2 border-cyan-100 text-cyan-600 rounded-3xl py-5 flex flex-col items-center justify-center gap-2 cursor-pointer active:scale-95 transition shadow-sm hover:bg-cyan-100 hover:border-cyan-300 hover:shadow-md">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md text-cyan-500 text-xl"><i class="fas fa-camera"></i></div>
                            <span class="text-xs font-extrabold uppercase tracking-wide">ถ่ายรูป</span>
                        </label>
                        <input type="file" accept="image/*" id="galleryInput" class="hidden" multiple onchange="handleFileSelect(this)">
                        <label for="galleryInput" class="flex-1 bg-fuchsia-50 border-2 border-fuchsia-100 text-fuchsia-600 rounded-3xl py-5 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-fuchsia-100 hover:border-fuchsia-300 active:scale-95 transition shadow-sm hover:shadow-md">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md text-fuchsia-500 text-xl"><i class="fas fa-images"></i></div>
                            <span class="text-xs font-extrabold uppercase tracking-wide">เลือกรูป</span>
                        </label>
                    </div>
                    <div id="mediaDropZone" class="media-grid empty:hidden"></div>
                </div>

                <button onclick="submitTicket()" id="btnSubmit" class="w-full btn-gradient-submit text-white py-5 rounded-3xl shadow-2xl shadow-green-200 font-extrabold text-xl touch-card flex items-center justify-center gap-3 active:scale-95 transition-all disabled:opacity-50 disabled:grayscale relative overflow-hidden group border-b-8 border-[#047857]">
                    <div class="absolute inset-0 bg-white/20 group-hover:bg-white/10 transition"></div>
                    <i class="fas fa-paper-plane animate-pulse"></i><span>ส่งแจ้งซ่อมทันที!</span>
                </button>
            </section>
        </div>

        <div class="text-center pt-4 relative z-10">
            <button onclick="openHistoryModal()" class="text-red-500 text-xs font-bold py-2 px-6 rounded-full bg-white/50 hover:bg-white transition active:scale-95 shadow-sm border border-red-100">
                ดูประวัติการแจ้งซ่อมทั้งหมด <i class="fas fa-chevron-right text-[10px] ml-1"></i>
            </button>
        </div>
    </main>

    <!-- Floating Tracking Button -->
    <button onclick="openHistoryModal()" class="fab-history touch-card hover:scale-110 active:scale-90">
        <i class="fas fa-clipboard-list text-2xl"></i>
        <span>ติดตามงาน</span>
    </button>

    <!-- Asset Modal -->
    <div id="assetModal" class="fixed inset-0 bg-white z-[60] hidden flex flex-col animate-fadeIn">
        <div class="p-5 bg-white border-b shadow-md flex items-center gap-3 sticky top-0 z-10">
            <button onclick="closeAssetModal()" class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 active:bg-slate-300 transition shadow-sm border border-slate-200 shrink-0">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <div class="relative flex-1">
                <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" id="assetSearch" onkeyup="filterAssets()" placeholder="ค้นหาชื่อเครื่องจักร..." class="w-full pl-11 pr-5 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-orange-100 focus:border-orange-400 outline-none text-sm font-bold transition text-slate-700">
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="assetListContainer">
            <div class="text-center py-10 text-slate-400"><i class="fas fa-spinner fa-spin mr-2"></i> กำลังโหลดข้อมูล...</div>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-slate-50 w-full sm:w-[480px] h-[95vh] sm:h-[85vh] sm:rounded-2xl rounded-t-3xl flex flex-col shadow-2xl transform transition-transform duration-300 translate-y-full" id="historyModalContent">
            <div class="bg-white p-6 rounded-t-3xl border-b border-slate-100 sticky top-0 z-10 flex justify-between items-center shadow-sm">
                <div><h3 class="font-bold text-2xl text-slate-800 flex items-center gap-2"><i class="fas fa-history text-red-500"></i> ประวัติงานซ่อม</h3></div>
                <button onclick="closeHistoryModal()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 active:bg-slate-300 transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="bg-white px-6 py-4 border-b border-slate-100 flex gap-3">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-4 top-3 text-slate-400 text-xs"></i>
                    <input type="text" id="historySearchInput" onkeyup="filterHistory()" placeholder="ค้นหา Ticket ID..." class="w-full bg-slate-50 border-none rounded-2xl pl-10 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-red-100 outline-none transition font-medium">
                </div>
            </div>
            <div class="overflow-y-auto p-4 flex-1 pb-safe" id="historyListContainer"></div>
        </div>
    </div>

    <!-- Fullscreen Image -->
    <div id="imageViewerModal" class="fixed inset-0 bg-black/95 z-[70] hidden flex items-center justify-center touch-none" onclick="closeImageViewer()"><button class="absolute top-4 right-4 text-white/80 hover:text-white text-3xl p-2 z-10 cursor-pointer"><i class="fas fa-times"></i></button><img id="fullImage" class="max-w-full max-h-full object-contain p-2 transition-transform duration-200" src="" alt="Full size"></div>
    
    <!-- Scanner -->
    <div id="scannerModal" class="fixed inset-0 bg-black z-[70] hidden flex flex-col"><div class="flex justify-between items-center p-6 pt-safe bg-black/80 text-white backdrop-blur-md absolute top-0 w-full z-10"><span class="font-bold text-xl tracking-wide"><i class="fas fa-qrcode mr-2 text-blue-400"></i>สแกน QR</span><button onclick="stopScanner()" class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center hover:bg-white/30 active:scale-90 transition"><i class="fas fa-times text-xl"></i></button></div><div class="flex-1 flex items-center justify-center bg-black relative"><div id="reader" class="w-full h-full"></div><div class="absolute inset-0 pointer-events-none flex items-center justify-center"><div class="w-72 h-72 border-4 border-blue-400 rounded-3xl relative shadow-[0_0_80px_rgba(59,130,246,0.5)]"><div class="absolute inset-0 animate-pulse bg-blue-500/10"></div></div></div></div><div class="p-8 pb-12 bg-black text-center text-white"><p class="text-slate-300 text-base" id="scannerInstruction">ส่อง QR Code / Barcode</p></div></div>
    
    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-[80] hidden flex flex-col items-center justify-center backdrop-blur-sm"><div class="loader mb-4 border-t-red-500"></div><p class="text-slate-800 font-bold text-sm animate-pulse">กำลังบันทึกข้อมูล...</p></div>

    <script>
        // --- CONFIG & AUTH ---
        const SUPABASE_URL = 'https://nmezqexpvhdozpdzxxek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tZXpxZXhwdmhkb3pwZHp4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5OTAwNTEsImV4cCI6MjA4MjU2NjA1MX0.N1OjCh1sp0xx0DGFjR6yX2hix5oIX7suzrnvQk8qPWU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const Auth = {
            requireRole: () => { const s = localStorage.getItem('cmms_user_session'); if (!s) { window.location.href = 'index.html'; return null; } return JSON.parse(s); },
            logout: () => { localStorage.removeItem('cmms_user_session'); window.location.href = 'index.html'; }
        };

        const Utils = { formatDate: (d) => d ? dayjs(d).fromNow() : '-' };

        let currentUser = null, html5QrCode = null, allAssets = [], selectedIssue = null, mediaList = [], ticketsCache = [];

        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = Auth.requireRole(); 
            if (!currentUser) return;
            document.getElementById('userDisplayName').innerText = currentUser.full_name || currentUser.username;
            setTimeout(() => { const h = document.getElementById('historyModalContent'); if(h) h.classList.remove('translate-y-full'); }, 100);
            
            // Handle Android Back Button (History State)
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function () {
                if(!document.getElementById('assetModal').classList.contains('hidden')) { closeAssetModal(); window.history.pushState(null, null, window.location.href); }
                else if(!document.getElementById('historyModal').classList.contains('hidden')) { closeHistoryModal(); window.history.pushState(null, null, window.location.href); }
                else if(!document.getElementById('imageViewerModal').classList.contains('hidden')) { closeImageViewer(); window.history.pushState(null, null, window.location.href); }
                else if(!document.getElementById('scannerModal').classList.contains('hidden')) { stopScanner(); window.history.pushState(null, null, window.location.href); }
            };

            await Promise.all([fetchAssets(), fetchIssueOptions(), fetchHistory()]);
        });

        // --- HANDLERS ---
        function confirmReset() {
            if(confirm('ต้องการรีเซ็ตหน้าจอเพื่อเริ่มใหม่หรือไม่?')) location.reload();
        }

        function handleLogout() {
            if(confirm('ต้องการออกจากระบบใช่หรือไม่?')) {
                window.location.href = 'index.html'; 
            }
        }

        function showToast(msg, type='info') {
            const box = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            let icon = type==='success'?'fa-check-circle text-green-500':(type==='error'?'fa-exclamation-circle text-red-500':'fa-info-circle text-blue-500');
            el.innerHTML = `<i class="fas ${icon} text-2xl"></i><span class="text-sm font-bold text-slate-700">${msg}</span>`;
            box.appendChild(el);
            setTimeout(() => { el.style.animation='fadeOut 0.3s forwards'; setTimeout(()=>el.remove(),300); }, 3000);
        }

        function setPriority(level) {
            document.querySelectorAll('.priority-btn').forEach(b => b.className = 'priority-btn');
            const btn = document.getElementById(`prio-${level}`);
            let val = 'ปกติ';
            if(level==='urgent') { btn.classList.add('active-urgent'); val='ด่วน'; }
            else if(level==='emergency') { btn.classList.add('active-emergency'); val='ด่วนที่สุด'; }
            else { btn.classList.add('active-normal'); }
            document.getElementById('priorityInput').value = val;
        }

        // --- DATA ---
        async function fetchAssets() { try { const {data}=await supabaseClient.from('assets').select('*').or('status.eq.active,status.eq.ACTIVE'); allAssets=data||[]; } catch(e){} }
        async function fetchIssueOptions() {
            try {
                const {data}=await supabaseClient.from('issue_options').select('*').eq('is_active',true).order('sort_order');
                const c=document.getElementById('issueOptionsContainer'); c.innerHTML='';
                (data||[]).forEach(o => {
                    c.innerHTML += `<div class="issue-card cursor-pointer touch-card" onclick="selectIssue(this,'${o.label}')"><div class="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center mb-1 shadow-sm"><i class="fas ${o.icon_class} text-xl text-slate-400"></i></div><span class="text-[11px] font-bold text-slate-600 text-center leading-tight px-1">${o.label}</span></div>`;
                });
            } catch(e){}
        }

        function selectIssue(el, label) {
            selectedIssue = label;
            document.querySelectorAll('.issue-card').forEach(c => { c.classList.remove('selected'); c.querySelector('i').classList.replace('text-purple-600','text-slate-400'); });
            el.classList.add('selected'); el.querySelector('i').classList.replace('text-slate-400','text-purple-600');
            setTimeout(() => document.getElementById('step3').scrollIntoView({behavior:'smooth',block:'center'}), 300);
        }

        async function fetchHistory() {
            try {
                const { data } = await supabaseClient.from('tickets').select('*').eq('requester_id', currentUser.id).order('incident_time', { ascending: false });
                const ids = [...new Set(data.map(t=>t.asset_id).filter(Boolean))];
                let assetMap = {};
                if(ids.length) { const {data:a} = await supabaseClient.from('assets').select('id,name').in('id',ids); a?.forEach(x=>assetMap[x.id]=x.name); }
                ticketsCache = data.map(t => ({...t, asset_name: assetMap[t.asset_id]||'ไม่ระบุ'}));
                renderHistory();
            } catch(e){}
        }

        function renderHistory() {
            const list = document.getElementById('historyListContainer');
            if(!ticketsCache.length) { list.innerHTML='<div class="text-center py-12 text-slate-400 text-sm font-medium">ยังไม่มีประวัติการแจ้งซ่อม</div>'; return; }
            list.innerHTML = ticketsCache.map(t => {
                let stClass='bg-slate-100 text-slate-600', stLabel=t.status;
                if(t.status==='OPEN') { stClass='bg-red-50 text-red-600 border border-red-100'; stLabel='รอรับงาน'; }
                if(t.status==='IN_PROGRESS') { stClass='bg-blue-50 text-blue-600 border border-blue-100'; stLabel='กำลังซ่อม'; }
                if(t.status==='CLOSED') { stClass='bg-green-50 text-green-600 border border-green-100'; stLabel='เสร็จสิ้น'; }
                return `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm mb-3 relative hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-slate-800 text-base">${t.asset_name}</h4>
                            <div class="text-xs text-slate-500 mt-0.5 line-clamp-1">${t.issue_text}</div>
                        </div>
                        <span class="${stClass} px-3 py-1 rounded-xl text-[10px] font-extrabold shadow-sm">${stLabel}</span>
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t border-slate-50">
                        <div class="text-[10px] text-slate-400 font-medium"><i class="far fa-clock mr-1"></i> ${Utils.formatDate(t.incident_time)}</div>
                        <button onclick="window.open('print_job_sheet.html?id=${t.id}','_blank')" class="text-slate-400 hover:text-blue-600 p-2 rounded-full hover:bg-blue-50 transition"><i class="fas fa-print text-lg"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- ASSET LOGIC ---
        function openAssetModal() { 
            const c = document.getElementById('assetListContainer'); c.innerHTML=''; 
            allAssets.forEach(a => {
                c.innerHTML += `<div class="p-5 border-b border-slate-100 hover:bg-slate-50 cursor-pointer flex justify-between items-center transition" onclick='confirmAsset(${JSON.stringify(a)})'><div><div class="font-bold text-sm text-slate-800">${a.name}</div><div class="text-xs text-slate-400 font-mono mt-0.5">${a.asset_code||'-'}</div></div><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400"><i class="fas fa-chevron-right text-xs"></i></div></div>`;
            });
            document.getElementById('assetModal').classList.remove('hidden'); 
        }
        function closeAssetModal() { document.getElementById('assetModal').classList.add('hidden'); }
        
        function confirmAsset(a) {
            document.getElementById('assetId').value = a.id;
            document.getElementById('manualAssetInput').value = '';
            document.getElementById('manualLocationField').classList.add('hidden');
            document.getElementById('assetNameDisplay').innerText = a.name;
            document.getElementById('assetSerialDisplay').innerText = `ID: ${a.asset_code||'-'}`;
            document.getElementById('assetLocationDisplay').innerText = a.location||'-';
            
            const card = document.getElementById('selectedAssetCard');
            card.classList.remove('hidden');
            closeAssetModal(); stopScanner();
            unlockSteps();
        }
        
        function clearAsset() {
            document.getElementById('assetId').value = '';
            document.getElementById('selectedAssetCard').classList.add('hidden');
            if(!document.getElementById('manualAssetInput').value) lockSteps();
        }

        function handleManualInput(el) {
            if(el.value.trim()) {
                document.getElementById('assetId').value = '';
                document.getElementById('selectedAssetCard').classList.add('hidden');
                document.getElementById('manualLocationField').classList.remove('hidden');
                unlockSteps(false);
            } else if(!document.getElementById('assetId').value) {
                document.getElementById('manualLocationField').classList.add('hidden');
                lockSteps();
            }
        }

        function unlockSteps(scroll=true) {
            document.getElementById('step2').classList.remove('opacity-50','pointer-events-none');
            document.getElementById('step3').classList.remove('opacity-50','pointer-events-none');
            if(scroll) setTimeout(()=>document.getElementById('step2').scrollIntoView({behavior:'smooth'}),300);
        }
        function lockSteps() {
            document.getElementById('step2').classList.add('opacity-50','pointer-events-none');
            document.getElementById('step3').classList.add('opacity-50','pointer-events-none');
        }

        // --- CAMERA & SUBMIT ---
        async function handleFileSelect(input) {
            if(mediaList.length+input.files.length > 5) return showToast("สูงสุด 5 รูป", 'error');
            document.getElementById('loadingOverlay').classList.remove('hidden');
            for(const f of input.files) {
                try {
                    const data = await uploadFileToSupabase(f); // Use Upload Logic
                    mediaList.push({type:'IMAGE', url: data}); // Store URL directly
                } catch(e){showToast(e.message, 'error')} } renderMedia(); document.getElementById('loadingOverlay').classList.add('hidden'); input.value=''; }
        
        // --- NEW: UPLOAD TO STORAGE ---
        async function uploadFileToSupabase(file) {
            const fileName = `job_${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
            const { data, error } = await supabaseClient.storage.from('repair-files').upload(fileName, file, { cacheControl: '3600', upsert: false });
            if (error) throw error;
            const { data: publicData } = supabaseClient.storage.from('repair-files').getPublicUrl(fileName);
            return publicData.publicUrl;
        }

        function renderMedia() { const z=document.getElementById('mediaDropZone'); z.innerHTML=''; mediaList.forEach((m,i)=>{ const d=document.createElement('div'); d.className='media-item'; d.innerHTML=m.type==='IMAGE'?`<img src="${m.url}">`:`<video src="${m.url}"></video><div class="video-indicator">VIDEO</div>`; d.innerHTML+=`<div class="delete-btn" onclick="removeMedia(${i})">&times;</div>`; z.appendChild(d); }); document.getElementById('mediaCount').innerText=mediaList.length+'/5'; }
        function removeMedia(i) { mediaList.splice(i,1); renderMedia(); }
        
        async function submitTicket() {
            const aid = document.getElementById('assetId').value;
            const man = document.getElementById('manualAssetInput').value.trim();
            const loc = document.getElementById('manualLocationInput').value.trim();
            const desc = document.getElementById('issueDescription').value;
            const prio = document.getElementById('priorityInput').value;
            const tel = document.getElementById('contactNumber').value;

            if(!aid && !man) return showToast("กรุณาระบุรายการแจ้งซ่อม", 'error');
            if(!selectedIssue) return showToast("กรุณาเลือกอาการเสีย", 'error');

            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            try {
                let fullDesc = desc;
                let meta = [];
                if(prio !== 'ปกติ') meta.push(`[ความเร่งด่วน: ${prio}]`);
                if(tel) meta.push(`[ติดต่อ: ${tel}]`);
                if(!aid && man) { meta.push(`[ซ่อมทั่วไป: ${man}]`); if(loc) meta.push(`[สถานที่: ${loc}]`); }
                
                if(meta.length) fullDesc = meta.join(' ') + '\n\n' + desc;

                const cover = mediaList.length > 0 ? mediaList[0].url : null; // Use URL
                
                const {data, error} = await supabaseClient.from('tickets').insert([{
                    asset_id: aid || null,
                    requester_id: currentUser.id,
                    issue_text: selectedIssue,
                    description: fullDesc,
                    photo_url: cover,
                    status: 'OPEN',
                    incident_time: new Date().toISOString()
                }]).select();

                if(error) throw error;
                const tid = data[0].id;

                if(mediaList.length) {
                    // Use URLs directly
                    const rows = mediaList.map(m => ({ticket_id: tid, type: 'IMAGE', url: m.url}));
                    await supabaseClient.from('media').insert(rows);
                }

                showToast("ส่งแจ้งซ่อมสำเร็จ!", 'success');
                if(confirm("ส่งงานเรียบร้อย! ต้องการพิมพ์ใบแจ้งซ่อมเลยไหม?")) {
                    window.open(`print_job_sheet.html?id=${tid}`, '_blank');
                }
                setTimeout(() => location.reload(), 500);

            } catch(e) { showToast(e.message, 'error'); document.getElementById('loadingOverlay').classList.add('hidden'); }
        }
        
        function openHistoryModal() { document.getElementById('historyModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('historyModalContent').classList.remove('translate-y-full'),10); fetchHistory(); }
        function closeHistoryModal() { document.getElementById('historyModalContent').classList.add('translate-y-full'); setTimeout(()=>document.getElementById('historyModal').classList.add('hidden'),300); }
        function closeImageViewer() { document.getElementById('imageViewerModal').classList.add('hidden'); }
        function stopScanner() { document.getElementById('scannerModal').classList.add('hidden'); if(html5QrCode) html5QrCode.stop(); }
        function startScanner() { 
            document.getElementById('scannerModal').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({facingMode:"environment"}, {fps:10}, (txt)=>{ confirmAsset(allAssets.find(a=>a.asset_code===txt)||{id:null,name:'Unknown',asset_code:txt}); }, ()=>{});
        }
    </script>
</body>
</html>