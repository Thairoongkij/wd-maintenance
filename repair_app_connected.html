<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>แจ้งซ่อมออนไลน์ - WD Maintenance</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>

    <script>
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.locale('th'); 
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #fff9f9; }
        
        /* --- THEME: FUN RED & YELLOW --- */
        .header-gradient { background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); }
        .btn-gradient-scan { background: linear-gradient(135deg, #facc15 0%, #eab308 100%); }
        .btn-gradient-submit { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .touch-card { transition: transform 0.1s; cursor: pointer; }
        .touch-card:active { transform: scale(0.96); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; margin-top: 10px; }
        .media-item { position: relative; aspect-ratio: 1; border-radius: 12px; overflow: hidden; border: 2px solid white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .media-item img { width: 100%; height: 100%; object-fit: cover; }
        .delete-btn { position: absolute; top: 4px; right: 4px; background: rgba(239, 68, 68, 0.9); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: 2px solid white; }
        
        .fab-history { position: fixed; bottom: 24px; right: 24px; background: #ef4444; color: white; padding: 14px 24px; border-radius: 50px; box-shadow: 0 10px 25px -5px rgba(239, 68, 68, 0.5); font-weight: bold; display: flex; align-items: center; gap: 10px; z-index: 40; transition: all 0.2s; border: 2px solid rgba(255,255,255,0.3); }
        .fab-history:active { transform: scale(0.95); }
        
        .step-badge { width: 30px; height: 30px; background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; flex-shrink: 0; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3); border: 2px solid white; }
        
        .modern-card { background: white; border-radius: 24px; box-shadow: 0 15px 35px -5px rgba(239, 68, 68, 0.1); border: 1px solid rgba(255,255,255,0.8); }
        .issue-card { border: 2px solid #fff1f2; border-radius: 16px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90px; transition: all 0.2s; background: #fff; position: relative; }
        .issue-card:active { transform: scale(0.95); }
        .issue-card.selected { border-color: #ef4444; background-color: #fef2f2; color: #b91c1c; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); }
        .issue-card i { transition: color 0.2s; }
        .issue-card.selected i { color: #ef4444 !important; }
        
        .priority-btn { border: 2px solid #f3f4f6; border-radius: 16px; padding: 10px; text-align: center; font-size: 12px; font-weight: bold; color: #64748b; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; background: white; }
        .priority-btn.active-normal { background-color: #ecfdf5; color: #059669; border-color: #34d399; } 
        .priority-btn.active-urgent { background-color: #fffbeb; color: #d97706; border-color: #fb923c; } 
        .priority-btn.active-emergency { background-color: #fef2f2; color: #ef4444; border-color: #f87171; animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { border-color: #f87171; } 50% { border-color: #fee2e2; } 100% { border-color: #f87171; } }

        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); padding: 14px 18px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out; pointer-events: auto; border: 1px solid rgba(255,255,255,0.5); font-weight: 600; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Loading Skeleton */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s ease-in-out infinite; border-radius: 12px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-card { height: 120px; margin-bottom: 12px; }
        .skeleton-text { height: 16px; width: 80%; margin-bottom: 8px; }
        .skeleton-title { height: 20px; width: 60%; margin-bottom: 12px; }

        /* Enhanced Transitions */
        * { scroll-behavior: smooth; }
        .modern-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modern-card:hover { transform: translateY(-2px); box-shadow: 0 20px 40px -5px rgba(239, 68, 68, 0.15); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-700 bg-[#fff1f2]">

    <div id="toast-container"></div>

    <header class="header-gradient px-6 py-6 shadow-xl shadow-red-200/50 z-30 flex justify-between items-center sticky top-0 shrink-0 text-white rounded-b-[35px] mx-[-2px]">
        <div class="flex items-center gap-3">
            <button onclick="confirmReset()" class="w-11 h-11 rounded-full bg-white/20 flex items-center justify-center hover:bg-white/30 transition backdrop-blur-md shadow-inner border-2 border-white/20 active:scale-95">
                <i class="fas fa-home text-white"></i>
            </button>
            <div>
                <h1 class="text-2xl font-black flex items-center gap-2 drop-shadow-md tracking-tight leading-none italic">แจ้งซ่อม <i class="fas fa-bolt text-yellow-300 animate-pulse"></i></h1>
                <p class="text-xs font-bold opacity-90 mt-1 ml-1 bg-black/20 inline-block px-3 py-0.5 rounded-full backdrop-blur-sm border border-white/20" id="userDisplayName">User</p>
            </div>
        </div>
        <button onclick="handleLogout()" class="px-4 py-2 rounded-2xl bg-white/20 border border-white/20 flex items-center gap-2 hover:bg-white/30 transition active:scale-95 shadow-sm">
            <span class="text-xs font-bold">ออก</span>
            <i class="fas fa-sign-out-alt text-sm"></i>
        </button>
    </header>

    <main class="flex-1 overflow-y-auto p-5 pb-32 relative scroll-smooth no-scrollbar" id="mainContainer">

        <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0 opacity-50">
            <div class="absolute top-[-50px] right-[-50px] w-64 h-64 bg-orange-300 rounded-full blur-[80px] mix-blend-multiply"></div>
            <div class="absolute top-[200px] left-[-50px] w-52 h-52 bg-red-300 rounded-full blur-[80px] mix-blend-multiply"></div>
            <div class="absolute bottom-[-20px] right-[20px] w-40 h-40 bg-yellow-200 rounded-full blur-[60px] mix-blend-multiply"></div>
        </div>

        <div class="relative z-10 space-y-6">
            <!-- Pending Inspection Banner -->
            <div id="pendingInspectionBanner" class="hidden modern-card p-5 border-l-8 border-purple-500 bg-gradient-to-r from-purple-50 to-white shadow-lg animate-pulse cursor-pointer" onclick="showPendingInspections()">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-full bg-purple-500 flex items-center justify-center text-white text-2xl shadow-lg">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-purple-700 mb-1">มีงานรอการตรวจสอบ</h3>
                        <p class="text-sm text-purple-600" id="pendingInspectionText">คุณมี 0 งานที่รอการอนุมัติ คลิกเพื่อดู</p>
                    </div>
                    <div class="text-purple-500">
                        <i class="fas fa-chevron-right text-2xl"></i>
                    </div>
                </div>
            </div>
            <section>
                <div class="flex items-center gap-3 mb-4 px-2">
                    <div class="step-badge">1</div>
                    <h2 class="text-xl font-bold text-slate-800">ระบุรายการแจ้งซ่อม</h2>
                </div>
                
                <div class="modern-card p-6 border-t-8 border-[#3b82f6]">
                    <button onclick="startScanner('ASSET')" class="w-full btn-gradient-scan text-white rounded-3xl py-6 shadow-xl shadow-blue-200 touch-card flex flex-col items-center justify-center gap-2 mb-5 active:scale-95 transition relative overflow-hidden group border-b-8 border-[#ca8a04]">
                        <i class="fas fa-qrcode text-4xl drop-shadow-md text-white animate-bounce"></i>
                        <span class="text-base font-extrabold tracking-widest text-white uppercase">สแกน QR Code</span>
                    </button>
                    
                    <div class="text-center mb-2">
                        <button onclick="openAssetModal()" class="text-slate-500 text-xs font-bold py-3 px-8 rounded-full bg-slate-100 hover:bg-white transition flex items-center justify-center gap-2 mx-auto border-2 border-slate-200 shadow-sm active:scale-95 hover:text-purple-600 hover:border-purple-200">
                            <i class="fas fa-list"></i> หรือ เลือกจากรายการ
                        </button>
                    </div>

                    <div id="selectedAssetCard" class="hidden bg-gradient-to-br from-blue-50 to-white border-2 border-blue-200 rounded-3xl p-5 relative animate-fadeIn shadow-lg mt-5">
                        <button onclick="clearAsset()" class="absolute top-3 right-3 text-slate-400 hover:text-red-500 bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-md transition active:scale-90 border border-slate-100 z-10">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                        <div class="pr-8">
                            <div class="text-[10px] font-bold text-blue-600 uppercase tracking-wider mb-2 bg-blue-100 inline-block px-3 py-1 rounded-lg">Selected</div>
                            <div class="font-extrabold text-slate-800 text-xl leading-tight mb-2" id="assetNameDisplay">-</div>
                            <div class="flex flex-wrap gap-2 text-[11px] font-medium text-slate-500">
                                <span class="bg-white px-3 py-1.5 rounded-xl border border-blue-100 font-mono text-blue-600 shadow-sm"><i class="fas fa-tag mr-1"></i> <span id="assetSerialDisplay">-</span></span>
                                <span class="bg-white px-3 py-1.5 rounded-xl border border-blue-100 shadow-sm"><i class="fas fa-map-marker-alt text-red-400 mr-1"></i> <span id="assetLocationDisplay">-</span></span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="assetId">

                    <div class="relative mt-8 pt-6 border-t-2 border-dashed border-slate-200">
                        <div class="absolute top-[-14px] left-1/2 transform -translate-x-1/2 bg-white px-4 py-1 text-xs text-slate-400 font-bold uppercase tracking-widest rounded-full border border-slate-200 shadow-sm">Manual</div>
                        <label class="text-xs font-bold text-slate-500 block mb-3 mt-2 flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-orange-100 flex items-center justify-center text-orange-500"><i class="fas fa-pen text-xs"></i></div> ซ่อมทั่วไป (ไม่มี QR)</label>
                        <input type="text" id="manualAssetInput" oninput="handleManualInput(this)" class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-400 focus:bg-white outline-none transition placeholder-slate-400 font-bold text-slate-700" placeholder="พิมพ์ชื่ออุปกรณ์ที่นี่...">
                        <div id="manualLocationField" class="hidden mt-3 animate-fadeIn">
                             <input type="text" id="manualLocationInput" class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-purple-100 focus:border-purple-400 focus:bg-white outline-none transition placeholder-slate-400 font-medium" placeholder="ระบุสถานที่ (ชั้น/ห้อง/บริเวณ)...">
                        </div>
                    </div>
                </div>
            </section>

            <section class="opacity-50 pointer-events-none transition-all duration-500" id="step2">
                <div class="flex items-center gap-3 mb-4 px-2">
                    <div class="step-badge">2</div>
                    <h2 class="text-xl font-bold text-slate-800">รายละเอียดอาการ</h2>
                </div>
                
                <div class="modern-card p-6 space-y-6 border-l-8 border-l-[#ec4899]">
                    <div>
                        <label class="text-xs font-bold text-slate-400 mb-3 block uppercase tracking-wide flex items-center gap-2"><i class="fas fa-fire text-red-500 animate-pulse"></i> ความเร่งด่วน</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button type="button" onclick="setPriority('normal')" id="prio-normal" class="priority-btn active-normal"><i class="fas fa-smile text-3xl mb-2"></i> ปกติ</button>
                            <button type="button" onclick="setPriority('urgent')" id="prio-urgent" class="priority-btn"><i class="fas fa-exclamation-circle text-3xl mb-2"></i> ด่วน</button>
                            <button type="button" onclick="setPriority('emergency')" id="prio-emergency" class="priority-btn"><i class="fas fa-radiation-alt text-3xl mb-2 animate-spin-slow"></i> ด่วนที่สุด</button>
                        </div>
                        <input type="hidden" id="priorityInput" value="ปกติ">
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 mb-3 block uppercase tracking-wide">อาการที่พบ</label>
                        <div class="grid grid-cols-3 gap-3" id="issueOptionsContainer">
                            <div class="col-span-3 text-center text-slate-400 py-4 text-xs">Loading...</div>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 mb-3 block uppercase tracking-wide">เพิ่มเติม & ติดต่อ</label>
                        <textarea id="issueDescription" rows="2" class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-pink-100 focus:border-pink-400 focus:bg-white transition placeholder-slate-400 mb-4 font-medium text-slate-700" placeholder="มีอะไรเพิ่มเติมบอกช่างได้เลย..."></textarea>
                        <div class="relative">
                            <div class="absolute left-4 top-3.5 w-9 h-9 bg-green-100 rounded-full flex items-center justify-center text-green-600 shadow-sm"><i class="fas fa-phone-alt text-xs"></i></div>
                            <input type="tel" id="contactNumber" class="w-full bg-slate-50 border-2 border-slate-200 rounded-full pl-16 pr-6 py-4 text-sm focus:ring-4 focus:ring-green-100 focus:border-green-400 focus:bg-white transition placeholder-slate-400 font-bold text-slate-700" placeholder="เบอร์โทรติดต่อกลับ">
                        </div>
                    </div>
                </div>
            </section>

            <section class="opacity-50 pointer-events-none transition-all duration-500 pb-8" id="step3">
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-3">
                        <div class="step-badge">3</div>
                        <h2 class="text-xl font-bold text-slate-800">รูปภาพประกอบ</h2>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500 bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm" id="mediaCount">0/5</span>
                </div>
                
                <div class="modern-card p-6 mb-8 border-b-8 border-[#10b981]">
                    <div class="flex gap-4 mb-5">
                        <input type="file" accept="image/*" capture="environment" id="cameraInput" class="hidden" onchange="handleFileSelect(this)">
                        <label for="cameraInput" class="flex-1 bg-cyan-50 border-2 border-cyan-100 text-cyan-600 rounded-3xl py-5 flex flex-col items-center justify-center gap-2 cursor-pointer active:scale-95 transition shadow-sm hover:bg-cyan-100 hover:border-cyan-300 hover:shadow-md">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md text-cyan-500 text-xl"><i class="fas fa-camera"></i></div>
                            <span class="text-xs font-extrabold uppercase tracking-wide">ถ่ายรูป</span>
                        </label>
                        <input type="file" accept="image/*" id="galleryInput" class="hidden" multiple onchange="handleFileSelect(this)">
                        <label for="galleryInput" class="flex-1 bg-fuchsia-50 border-2 border-fuchsia-100 text-fuchsia-600 rounded-3xl py-5 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-fuchsia-100 hover:border-fuchsia-300 active:scale-95 transition shadow-sm hover:shadow-md">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md text-fuchsia-500 text-xl"><i class="fas fa-images"></i></div>
                            <span class="text-xs font-extrabold uppercase tracking-wide">เลือกรูป</span>
                        </label>
                    </div>
                    <div id="mediaDropZone" class="media-grid empty:hidden"></div>
                </div>

                <button onclick="submitTicket()" id="btnSubmit" class="w-full btn-gradient-submit text-white py-5 rounded-3xl shadow-2xl shadow-green-200 font-extrabold text-xl touch-card flex items-center justify-center gap-3 active:scale-95 transition-all disabled:opacity-50 disabled:grayscale relative overflow-hidden group border-b-8 border-[#047857]">
                    <div class="absolute inset-0 bg-white/20 group-hover:bg-white/10 transition"></div>
                    <i class="fas fa-paper-plane animate-pulse"></i><span>ส่งแจ้งซ่อมทันที!</span>
                </button>
            </section>
        </div>

        <div class="text-center pt-4 relative z-10 space-y-3">
            <button onclick="openHistoryModal()" class="text-purple-500 text-xs font-bold py-3 px-6 rounded-full bg-white/60 hover:bg-white transition active:scale-95 shadow-sm border border-purple-100 backdrop-blur-sm">
                ดูประวัติการแจ้งซ่อมของฉัน <i class="fas fa-chevron-right text-[10px] ml-1"></i>
            </button>
            <div>
                <button onclick="openAllHistoryModal()" class="text-blue-600 text-xs font-bold py-3 px-6 rounded-full bg-blue-50 hover:bg-blue-100 transition active:scale-95 shadow-sm border border-blue-200">
                    <i class="fas fa-globe"></i> ดูประวัติงานซ่อมทั้งหมด (All History) <i class="fas fa-chevron-right text-[10px] ml-1"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Floating Tracking Button -->
    <button onclick="openHistoryModal()" class="fab-history touch-card hover:scale-110 active:scale-90">
        <i class="fas fa-search-location text-2xl animate-pulse"></i>
        <span>ติดตามสถานะ</span>
    </button>

    <!-- Asset Modal -->
    <div id="assetModal" class="fixed inset-0 bg-white z-[60] hidden flex flex-col animate-fadeIn">
        <div class="p-5 bg-white border-b shadow-md flex items-center gap-3 sticky top-0 z-10">
            <button onclick="closeAssetModal()" class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 active:bg-slate-300 transition shadow-sm border border-slate-200 shrink-0">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <div class="relative flex-1">
                <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" id="assetSearch" onkeyup="filterAssets()" placeholder="ค้นหาชื่อเครื่องจักร..." class="w-full pl-11 pr-5 py-3 rounded-2xl border-2 border-slate-100 bg-slate-50 focus:bg-white focus:ring-4 focus:ring-purple-100 focus:border-purple-400 outline-none text-sm font-bold transition text-slate-700">
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-2" id="assetListContainer">
            <div class="text-center py-10 text-slate-400"><i class="fas fa-spinner fa-spin mr-2"></i> กำลังโหลดข้อมูล...</div>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-slate-50 w-full sm:w-[480px] h-[95vh] sm:h-[85vh] sm:rounded-2xl rounded-t-3xl flex flex-col shadow-2xl transform transition-transform duration-300 translate-y-full" id="historyModalContent">
            <div class="bg-white p-6 rounded-t-3xl border-b border-slate-100 sticky top-0 z-10 flex justify-between items-center shadow-sm">
                <div><h3 class="font-bold text-2xl text-slate-800 flex items-center gap-2"><i class="fas fa-history text-purple-500"></i> ประวัติงานซ่อม</h3></div>
                <button onclick="closeHistoryModal()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 active:bg-slate-300 transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="bg-white px-6 py-4 border-b border-slate-100 flex gap-3">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-4 top-3 text-slate-400 text-xs"></i>
                    <input type="text" id="historySearchInput" onkeyup="filterHistory()" placeholder="ค้นหา Ticket ID..." class="w-full bg-slate-50 border-none rounded-2xl pl-10 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-purple-100 outline-none transition font-medium">
                </div>
            </div>
            <div class="overflow-y-auto p-4 flex-1 pb-safe" id="historyListContainer"></div>
        </div>
    </div>
    
    <!-- All History Modal (All Tickets with Filters) -->
    <div id="allHistoryModal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-slate-50 w-full sm:w-[650px] h-[95vh] sm:h-[90vh] sm:rounded-2xl rounded-t-3xl flex flex-col shadow-2xl transform transition-transform duration-300 translate-y-full" id="allHistoryModalContent">
            <div class="bg-white p-6 rounded-t-3xl border-b border-slate-100 sticky top-0 z-10 flex justify-between items-center shadow-sm">
                <div><h3 class="font-bold text-2xl text-slate-800 flex items-center gap-2"><i class="fas fa-globe text-blue-500"></i> ประวัติงานซ่อมทั้งหมด</h3><p class="text-xs text-slate-500 mt-1">ดูข้อมูลทุกใบแจ้งซ่อม (Read-only)</p></div>
                <button onclick="closeAllHistoryModal()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 active:bg-slate-300 transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            <!-- Advanced Filters -->
            <div class="bg-white px-6 py-4 border-b border-slate-100 space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="allHistorySearch" oninput="filterAllHistory()" placeholder="ค้นหา Ticket ID..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none transition font-medium">
                    <select id="allHistoryStatus" onchange="filterAllHistory()" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none transition font-medium cursor-pointer">
                        <option value="ALL">สถานะ: ทั้งหมด</option>
                        <option value="OPEN">รอรับงาน</option>
                        <option value="IN_PROGRESS">กำลังซ่อม</option>
                        <option value="PENDING_INSPECTION">รอตรวจสอบ</option>
                        <option value="CLOSED">เสร็จสิ้น</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="allHistoryAsset" onchange="filterAllHistory()" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none transition font-medium cursor-pointer">
                        <option value="ALL">เครื่องจักร: ทั้งหมด</option>
                    </select>
                    <select id="allHistoryTech" onchange="filterAllHistory()" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none transition font-medium cursor-pointer">
                        <option value="ALL">ช่าง: ทั้งหมด</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <input type="date" id="allHistoryDateStart" onchange="filterAllHistory()" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none transition font-medium cursor-pointer">
                    <span class="flex items-center text-slate-400">-</span>
                    <input type="date" id="allHistoryDateEnd" onchange="filterAllHistory()" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-100 outline-none transition font-medium cursor-pointer">
                </div>
                <button onclick="resetAllHistoryFilters()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-2 rounded-xl font-bold transition text-sm">
                    <i class="fas fa-undo-alt mr-2"></i> รีเซ็ตฟิลเตอร์
                </button>
            </div>
            <div class="overflow-y-auto p-4 flex-1 pb-safe" id="allHistoryListContainer">
                <div class="text-center py-10 text-slate-400 text-sm">กำลังโหลดข้อมูล...</div>
            </div>
        </div>
    </div>

    <!-- Detail Modal (Fixed Images & Content) -->
    <div id="ticketDetailModal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center backdrop-blur-sm transition-opacity p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl flex flex-col overflow-hidden max-h-[90vh]">
            <div class="px-6 py-4 border-b bg-white flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold text-slate-800">รายละเอียดงาน</h3>
                <button onclick="closeTicketDetail()" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center hover:bg-slate-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-slate-50/50 space-y-4">
                
                <!-- Status Banner -->
                <div id="detailStatusBanner" class="p-4 rounded-2xl text-center font-bold text-lg mb-2 shadow-sm"></div>

                <!-- Info -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="mb-4">
                        <label class="text-xs font-bold text-slate-400 uppercase">เครื่องจักร / ทรัพย์สิน</label>
                        <div id="detailAssetName" class="text-lg font-bold text-slate-800"></div>
                        <div id="detailAssetCode" class="text-xs font-mono text-slate-500 bg-slate-100 inline-block px-2 py-0.5 rounded mt-1"></div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">อาการที่แจ้ง</label>
                        <div id="detailIssue" class="text-base font-medium text-slate-700"></div>
                        <div id="detailDesc" class="text-sm text-slate-500 mt-1"></div>
                    </div>
                </div>

                <!-- Technician Report -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                     <label class="text-xs font-bold text-slate-400 uppercase mb-2 block"><i class="fas fa-wrench"></i> การแก้ไขโดยช่าง</label>
                     <div id="detailRepairNote" class="text-sm text-slate-700 leading-relaxed bg-slate-50 p-3 rounded-xl border border-slate-100"></div>
                </div>

                <!-- Images (Gallery with Labels) -->
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase mb-2 block">รูปภาพประกอบ</label>
                    <div id="detailImageGallery" class="grid grid-cols-2 gap-3"></div>
                </div>
            </div>
            <div class="p-4 bg-white border-t">
                <!-- Approval Section (Only for PENDING_INSPECTION status & requester) -->
                <div id="approvalSection" class="hidden mb-4 space-y-3">
                    <div class="bg-purple-50 border border-purple-200 rounded-2xl p-4 text-center">
                        <p class="text-purple-700 font-bold text-sm mb-3">
                            <i class="fas fa-clipboard-check"></i> งานนี้รอการตรวจสอบจากคุณ
                        </p>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="approveTicket()" class="bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-lg">
                                <i class="fas fa-check-circle"></i> อนุมัติ
                            </button>
                            <button onclick="openRejectModal()" class="bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-lg">
                                <i class="fas fa-times-circle"></i> ส่งกลับแก้ไข
                            </button>
                        </div>
                    </div>
                </div>
                <button onclick="closeTicketDetail()" class="w-full py-3 rounded-xl bg-slate-100 text-slate-700 font-bold hover:bg-slate-200">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div id="rejectModal" class="fixed inset-0 bg-slate-900/80 z-[80] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b bg-red-50">
                <h3 class="text-xl font-bold text-red-600 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i> ส่งกลับแก้ไข
                </h3>
            </div>
            <div class="p-6">
                <label class="text-sm font-bold text-slate-600 mb-3 block">เหตุผลที่ต้องแก้ไข *</label>
                <textarea id="rejectReason" rows="4" class="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 text-sm focus:ring-4 focus:ring-red-100 focus:border-red-400 focus:bg-white transition placeholder-slate-400" placeholder="ระบุสิ่งที่ต้องการให้ช่างแก้ไข..."></textarea>
            </div>
            <div class="p-4 bg-slate-50 flex gap-3">
                <button onclick="closeRejectModal()" class="flex-1 py-3 rounded-xl bg-slate-200 text-slate-700 font-bold hover:bg-slate-300">ยกเลิก</button>
                <button onclick="submitReject()" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600">ยืนยันส่งกลับ</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Image -->
    <div id="imageViewerModal" class="fixed inset-0 bg-black/95 z-[80] hidden flex items-center justify-center touch-none" onclick="closeImageViewer()"><button class="absolute top-4 right-4 text-white/80 hover:text-white text-3xl p-2 z-10 cursor-pointer"><i class="fas fa-times"></i></button><img id="fullImage" class="max-w-full max-h-full object-contain p-2 transition-transform duration-200" src="" alt="Full size"></div>
    
    <!-- Scanner -->
    <div id="scannerModal" class="fixed inset-0 bg-black z-[70] hidden flex flex-col"><div class="flex justify-between items-center p-6 pt-safe bg-black/80 text-white backdrop-blur-md absolute top-0 w-full z-10"><span class="font-bold text-xl tracking-wide"><i class="fas fa-qrcode mr-2 text-blue-400"></i>สแกน QR</span><button onclick="stopScanner()" class="bg-white/20 w-12 h-12 rounded-full flex items-center justify-center hover:bg-white/30 active:scale-90 transition"><i class="fas fa-times text-xl"></i></button></div><div class="flex-1 flex items-center justify-center bg-black relative"><div id="reader" class="w-full h-full"></div><div class="absolute inset-0 pointer-events-none flex items-center justify-center"><div class="w-72 h-72 border-4 border-blue-400 rounded-3xl relative shadow-[0_0_80px_rgba(59,130,246,0.5)]"><div class="absolute inset-0 animate-pulse bg-blue-500/10"></div></div></div></div><div class="p-8 pb-12 bg-black text-center text-white"><p class="text-slate-300 text-base" id="scannerInstruction">ส่อง QR Code / Barcode</p></div></div>
    
    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-[80] hidden flex flex-col items-center justify-center backdrop-blur-sm"><div class="loader mb-4 border-t-purple-500"></div><p class="text-slate-800 font-bold text-sm animate-pulse">กำลังบันทึกข้อมูล...</p></div>

    <script>
        // --- EMBEDDED CONFIG & AUTH ---
        const SUPABASE_URL = 'https://nmezqexpvhdozpdzxxek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tZXpxZXhwdmhkb3pwZHp4eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5OTAwNTEsImV4cCI6MjA4MjU2NjA1MX0.N1OjCh1sp0xx0DGFjR6yX2hix5oIX7suzrnvQk8qPWU';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const Auth = {
            requireRole: (allowedRoles = []) => {
                const session = localStorage.getItem('cmms_user_session');
                if (!session) { window.location.href = 'index.html'; return null; }
                const user = JSON.parse(session);
                return user;
            },
            logout: () => { if(confirm('ออกจากระบบ?')) { localStorage.removeItem('cmms_user_session'); window.location.href = 'index.html'; } },
        };

        const Utils = {
            formatDate: (d) => d ? dayjs(d).format('DD MMM • HH:mm') : '-',
            safeRedirect: (url) => { try { window.location.href = url; } catch(e) { console.error(e); } }
        };

        // --- MAIN LOGIC ---
        let currentUser = null;
        let html5QrCode = null;
        let allAssets = [];
        let selectedIssue = null;
        let mediaList = [];
        let ticketsCache = [];
        let scannerMode = 'ASSET';

        // --- GLOBAL FUNCTIONS (WINDOW BINDING) ---
        window.confirmReset = function() { if(confirm('รีเซ็ตหน้าจอ?')) location.reload(); }
        window.handleLogout = function() { Auth.logout(); }
        
        window.openHistoryModal = function() {
            document.getElementById('historyModal').classList.remove('hidden');
            setTimeout(()=>document.getElementById('historyModalContent').classList.remove('translate-y-full'),10);
            showHistoryLoading(); // Show skeleton first
            fetchHistory();
        }
        window.closeHistoryModal = function() { 
            document.getElementById('historyModalContent').classList.add('translate-y-full'); 
            setTimeout(()=>document.getElementById('historyModal').classList.add('hidden'),300); 
        }
        
        window.openAssetModal = function() { 
            const c = document.getElementById('assetListContainer'); c.innerHTML=''; 
            allAssets.forEach(a => {
                c.innerHTML += `<div class="p-5 border-b border-slate-100 hover:bg-slate-50 cursor-pointer flex justify-between items-center transition" onclick='confirmAsset(${JSON.stringify(a)})'><div><div class="font-bold text-sm text-slate-800">${a.name}</div><div class="text-xs text-slate-400 font-mono mt-0.5">${a.asset_code||'-'}</div></div><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400"><i class="fas fa-chevron-right text-xs"></i></div></div>`;
            });
            document.getElementById('assetModal').classList.remove('hidden'); 
        }
        window.closeAssetModal = function() { document.getElementById('assetModal').classList.add('hidden'); }

        window.closeImageViewer = function() { document.getElementById('imageViewerModal').classList.add('hidden'); }
        window.viewImage = function(url) { document.getElementById('fullImage').src=url; document.getElementById('imageViewerModal').classList.remove('hidden'); }
        
        window.stopScanner = function() { document.getElementById('scannerModal').classList.add('hidden'); if(html5QrCode) html5QrCode.stop(); }
        window.startScanner = function(mode) { 
            scannerMode = mode;
            document.getElementById('scannerModal').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({facingMode:"environment"}, {fps:10}, (txt)=>{ 
                if(scannerMode==='ASSET'){
                    confirmAsset(allAssets.find(a=>a.asset_code===txt)||{id:null,name:'Unknown',asset_code:txt});
                } else {
                    document.getElementById('historySearchInput').value = txt;
                    filterHistory();
                    stopScanner();
                }
            }, ()=>{});
        }

        window.showToast = function(msg, type='info') {
            const box = document.getElementById('toast-container');
            const el = document.createElement('div'); el.className = `toast ${type}`;
            let icon = type==='success'?'fa-check-circle text-green-500':(type==='error'?'fa-exclamation-circle text-red-500':'fa-info-circle text-blue-500');
            el.innerHTML = `<i class="fas ${icon} text-2xl"></i><span class="text-sm font-bold text-slate-700">${msg}</span>`;
            box.appendChild(el); setTimeout(() => { el.style.animation='fadeOut 0.3s forwards'; setTimeout(()=>el.remove(),300); }, 3000);
        }

        window.setPriority = function(level) {
            document.querySelectorAll('.priority-btn').forEach(b => b.className = 'priority-btn');
            const btn = document.getElementById(`prio-${level}`);
            let val = 'ปกติ';
            if(level==='urgent') { btn.classList.add('active-urgent'); val='ด่วน'; }
            else if(level==='emergency') { btn.classList.add('active-emergency'); val='ด่วนที่สุด'; }
            else { btn.classList.add('active-normal'); }
            document.getElementById('priorityInput').value = val;
        }

        window.selectIssue = function(el, label) {
            selectedIssue = label;
            document.querySelectorAll('.issue-card').forEach(c => { c.classList.remove('selected'); c.querySelector('i').classList.replace('text-purple-600','text-slate-400'); });
            el.classList.add('selected'); el.querySelector('i').classList.replace('text-slate-400','text-purple-600');
            setTimeout(() => document.getElementById('step3').scrollIntoView({behavior:'smooth',block:'center'}), 300);
        }

        window.confirmAsset = function(a) {
            document.getElementById('assetId').value = a.id;
            document.getElementById('manualAssetInput').value = '';
            document.getElementById('manualLocationField').classList.add('hidden');
            document.getElementById('assetNameDisplay').innerText = a.name;
            document.getElementById('assetSerialDisplay').innerText = `ID: ${a.asset_code||'-'}`;
            document.getElementById('assetLocationDisplay').innerText = a.location||'-';
            document.getElementById('selectedAssetCard').classList.remove('hidden');
            closeAssetModal(); stopScanner(); unlockSteps();
        }
        
        window.clearAsset = function() {
            document.getElementById('assetId').value = '';
            document.getElementById('selectedAssetCard').classList.add('hidden');
            if(!document.getElementById('manualAssetInput').value) lockSteps();
        }

        window.handleManualInput = function(el) {
            if(el.value.trim()) {
                document.getElementById('assetId').value = '';
                document.getElementById('selectedAssetCard').classList.add('hidden');
                document.getElementById('manualLocationField').classList.remove('hidden');
                unlockSteps(false);
            } else if(!document.getElementById('assetId').value) {
                document.getElementById('manualLocationField').classList.add('hidden');
                lockSteps();
            }
        }

        window.unlockSteps = function(scroll=true) {
            document.getElementById('step2').classList.remove('opacity-50','pointer-events-none');
            document.getElementById('step3').classList.remove('opacity-50','pointer-events-none');
            if(scroll) setTimeout(()=>document.getElementById('step2').scrollIntoView({behavior:'smooth'}),300);
        }
        window.lockSteps = function() {
            document.getElementById('step2').classList.add('opacity-50','pointer-events-none');
            document.getElementById('step3').classList.add('opacity-50','pointer-events-none');
        }

        window.handleFileSelect = async function(input) {
            if(mediaList.length+input.files.length > 5) return showToast("สูงสุด 5 รูป", 'error');
            document.getElementById('loadingOverlay').classList.remove('hidden');
            for(const f of input.files) {
                try {
                    const url = await uploadFileToSupabase(f);
                    mediaList.push({type:'BEFORE_IMAGE', url: url});
                } catch(e){showToast(e.message, 'error')}
            } 
            renderMedia(); 
            document.getElementById('loadingOverlay').classList.add('hidden'); 
            input.value=''; 
        }

        window.removeMedia = function(i) { mediaList.splice(i,1); renderMedia(); }
        
        window.filterHistory = function() { 
            const t=document.getElementById('historySearchInput').value.toLowerCase(); 
            const f=ticketsCache.filter(x=>x.id.toLowerCase().includes(t)||x.asset_name.toLowerCase().includes(t)); 
            renderHistory(f); 
        }
        
        window.filterAssets = function() { 
            const t=document.getElementById('assetSearch').value.toLowerCase(); 
            Array.from(document.getElementById('assetListContainer').children).forEach(el=>{ 
                el.style.display=el.innerText.toLowerCase().includes(t)?'flex':'none'; 
            }); 
        }

        window.currentViewingTicket = null; // Store current ticket for approval actions

        window.openTicketDetail = function(index) {
            const t = ticketsCache[index];
            if(!t) return;

            window.currentViewingTicket = t; // Store for approval

            // Status
            const banner = document.getElementById('detailStatusBanner');
            if(t.status==='OPEN') { banner.className='p-4 rounded-2xl text-center font-bold text-lg mb-2 shadow-sm bg-red-50 text-red-600 border border-red-100'; banner.innerHTML='<i class="fas fa-clock"></i> รอช่างรับงาน'; }
            else if(t.status==='IN_PROGRESS') { banner.className='p-4 rounded-2xl text-center font-bold text-lg mb-2 shadow-sm bg-blue-50 text-blue-600 border border-blue-100'; banner.innerHTML='<i class="fas fa-tools"></i> กำลังซ่อมแซม'; }
            else if(t.status==='PENDING_INSPECTION') { banner.className='p-4 rounded-2xl text-center font-bold text-lg mb-2 shadow-sm bg-purple-50 text-purple-600 border border-purple-100'; banner.innerHTML='<i class="fas fa-check-circle"></i> ซ่อมเสร็จแล้ว (รอตรวจ)'; }
            else { banner.className='p-4 rounded-2xl text-center font-bold text-lg mb-2 shadow-sm bg-green-50 text-green-600 border border-green-100'; banner.innerHTML='<i class="fas fa-check-double"></i> ปิดงานเรียบร้อย'; }

            // Show approval section if PENDING_INSPECTION and user is requester OR admin
            const approvalSection = document.getElementById('approvalSection');
            const isRequester = t.requester_id === currentUser.id;
            const isAdmin = currentUser.role === 'admin';
            const canApprove = isRequester || isAdmin;

            if(t.status === 'PENDING_INSPECTION' && canApprove) {
                approvalSection.classList.remove('hidden');

                // Update approval text based on user role
                const approvalText = approvalSection.querySelector('p');
                if (isRequester && !isAdmin) {
                    approvalText.innerHTML = '<i class="fas fa-clipboard-check"></i> <strong>คุณเป็นผู้แจ้งซ่อม</strong> - มีสิทธิ์ตรวจสอบและอนุมัติงานนี้';
                } else if (isAdmin && !isRequester) {
                    approvalText.innerHTML = '<i class="fas fa-shield-alt"></i> <strong>Admin Override</strong> - คุณสามารถอนุมัติงานนี้ได้';
                } else {
                    approvalText.innerHTML = '<i class="fas fa-clipboard-check"></i> งานนี้รอการตรวจสอบจากคุณ';
                }
            } else if(t.status === 'PENDING_INSPECTION' && !canApprove) {
                // Show informational message that user cannot approve
                approvalSection.classList.remove('hidden');
                approvalSection.innerHTML = `
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 text-center">
                        <p class="text-slate-600 font-medium text-sm mb-2">
                            <i class="fas fa-info-circle text-slate-400"></i> งานนี้รอการตรวจสอบจากผู้แจ้งซ่อม
                        </p>
                        <p class="text-xs text-slate-500">คุณไม่มีสิทธิ์อนุมัติงานนี้ (ผู้แจ้งซ่อมเท่านั้นที่สามารถอนุมัติได้)</p>
                    </div>
                `;
            } else {
                approvalSection.classList.add('hidden');
            }

            // Info
            document.getElementById('detailAssetName').innerText = t.asset_name;
            document.getElementById('detailAssetCode').innerText = `ID: ${t.asset_code || '-'}`;
            document.getElementById('detailIssue').innerText = t.issue_text;
            document.getElementById('detailDesc').innerText = t.description || '-';
            document.getElementById('detailRepairNote').innerText = t.repair_details || '- ยังไม่มีรายละเอียดการซ่อม -';

            // Images Gallery (Full Logic)
            const gal = document.getElementById('detailImageGallery');
            gal.innerHTML = '';

            // 1. Cover (Before)
            if(t.photo_url) {
                gal.innerHTML += `
                <div class="relative rounded-xl overflow-hidden aspect-square border border-slate-200 cursor-pointer group" onclick="viewImage('${t.photo_url}')">
                    <img src="${t.photo_url}" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 left-0 bg-black/50 text-white text-[10px] px-2 py-1 w-full text-center font-bold">BEFORE</div>
                </div>`;
            }

            // 2. Additional Media (After/More)
            if(t.media && t.media.length > 0) {
                t.media.forEach(m => {
                    const isAfter = m.type === 'AFTER_IMAGE';
                    const label = isAfter ? 'AFTER' : 'BEFORE';
                    const color = isAfter ? 'bg-green-600/80' : 'bg-blue-600/80';

                    gal.innerHTML += `
                    <div class="relative rounded-xl overflow-hidden aspect-square border border-slate-200 cursor-pointer group" onclick="viewImage('${m.url}')">
                        <img src="${m.url}" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 left-0 ${color} text-white text-[10px] px-2 py-1 w-full text-center font-bold">${label}</div>
                    </div>`;
                });
            }

            if(gal.innerHTML === '') gal.innerHTML = '<div class="col-span-2 text-center text-slate-400 text-sm py-4">- ไม่มีรูปภาพ -</div>';

            document.getElementById('ticketDetailModal').classList.remove('hidden');
        }

        window.closeTicketDetail = function() { document.getElementById('ticketDetailModal').classList.add('hidden'); }

        // --- APPROVAL SYSTEM FUNCTIONS ---
        window.approveTicket = async function() {
            if(!window.currentViewingTicket) return;

            // Permission check
            const isRequester = window.currentViewingTicket.requester_id === currentUser.id;
            const isAdmin = currentUser.role === 'admin';

            if(!isRequester && !isAdmin) {
                showToast('คุณไม่มีสิทธิ์อนุมัติงานนี้ (เฉพาะผู้แจ้งซ่อมเท่านั้น)', 'error');
                return;
            }

            if(!confirm('ยืนยันการอนุมัติงานนี้?')) return;

            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const { error } = await supabaseClient
                    .from('tickets')
                    .update({ status: 'CLOSED', finished_at: new Date().toISOString() })
                    .eq('id', window.currentViewingTicket.id);

                if(error) throw error;

                showToast('อนุมัติงานสำเร็จ!', 'success');
                closeTicketDetail();
                fetchHistory(); // Reload
            } catch(e) {
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        window.openRejectModal = function() {
            document.getElementById('rejectModal').classList.remove('hidden');
        }

        window.closeRejectModal = function() {
            document.getElementById('rejectModal').classList.add('hidden');
            document.getElementById('rejectReason').value = '';
        }

        window.submitReject = async function() {
            const reason = document.getElementById('rejectReason').value.trim();
            if(!reason) return showToast('กรุณาระบุเหตุผล', 'error');
            if(!window.currentViewingTicket) return;

            // Permission check
            const isRequester = window.currentViewingTicket.requester_id === currentUser.id;
            const isAdmin = currentUser.role === 'admin';

            if(!isRequester && !isAdmin) {
                showToast('คุณไม่มีสิทธิ์ส่งกลับแก้ไขงานนี้ (เฉพาะผู้แจ้งซ่อมเท่านั้น)', 'error');
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                // Update status back to IN_PROGRESS with rejection note
                const currentDesc = window.currentViewingTicket.description || '';
                const rejectionNote = `\n\n[❌ ส่งกลับแก้ไข: ${reason}]`;

                const { error } = await supabaseClient
                    .from('tickets')
                    .update({
                        status: 'IN_PROGRESS',
                        description: currentDesc + rejectionNote
                    })
                    .eq('id', window.currentViewingTicket.id);

                if(error) throw error;

                showToast('ส่งกลับแก้ไขเรียบร้อย', 'success');
                closeRejectModal();
                closeTicketDetail();
                fetchHistory(); // Reload
            } catch(e) {
                showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        window.submitTicket = async function() {
            const aid = document.getElementById('assetId').value;
            const man = document.getElementById('manualAssetInput').value.trim();
            const loc = document.getElementById('manualLocationInput').value.trim();
            const desc = document.getElementById('issueDescription').value;
            const prio = document.getElementById('priorityInput').value;
            const tel = document.getElementById('contactNumber') ? document.getElementById('contactNumber').value : '';

            if(!aid && !man) return showToast("กรุณาระบุรายการแจ้งซ่อม", 'error');
            if(!selectedIssue) return showToast("กรุณาเลือกอาการเสีย", 'error');

            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            try {
                let fullDesc = desc;
                let meta = [];
                if(prio !== 'ปกติ') meta.push(`[ความเร่งด่วน: ${prio}]`);
                if(tel) meta.push(`[ติดต่อ: ${tel}]`);
                if(!aid && man) { meta.push(`[ซ่อมทั่วไป: ${man}]`); if(loc) meta.push(`[สถานที่: ${loc}]`); }
                if(meta.length) fullDesc = meta.join(' ') + '\n\n' + desc;

                const cover = mediaList.length > 0 ? mediaList[0].url : null; 
                
                const {data, error} = await supabaseClient.from('tickets').insert([{ asset_id: aid || null, requester_id: currentUser.id, issue_text: selectedIssue, description: fullDesc, photo_url: cover, status: 'OPEN', incident_time: new Date().toISOString() }]).select();
                if(error) throw error;
                const tid = data[0].id;
                
                if(mediaList.length) {
                    const rows = mediaList.map(m => ({ticket_id: tid, type: 'BEFORE_IMAGE', url: m.url}));
                    await supabaseClient.from('media').insert(rows);
                }

                showToast("ส่งแจ้งซ่อมสำเร็จ!", 'success');
                if(confirm("ส่งงานเรียบร้อย! ต้องการพิมพ์ใบแจ้งซ่อมเลยไหม?")) window.open(`print_job_sheet.html?id=${tid}`, '_blank');
                setTimeout(() => location.reload(), 500);
            } catch(e) { showToast(e.message, 'error'); document.getElementById('loadingOverlay').classList.add('hidden'); }
        }

        // --- INTERNAL LOGIC ---
        async function fetchAssets() { try { const {data}=await supabaseClient.from('assets').select('*').or('status.eq.active,status.eq.ACTIVE'); allAssets=data||[]; } catch(e){} }
        
        async function fetchIssueOptions() {
            try {
                const {data}=await supabaseClient.from('issue_options').select('*').eq('is_active',true).order('sort_order');
                const c=document.getElementById('issueOptionsContainer'); c.innerHTML='';
                (data||[]).forEach(o => { c.innerHTML += `<div class="issue-card cursor-pointer touch-card" onclick="selectIssue(this,'${o.label}')"><div class="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center mb-1 shadow-sm"><i class="fas ${o.icon_class} text-xl text-slate-400"></i></div><span class="text-[11px] font-bold text-slate-600 text-center leading-tight px-1">${o.label}</span></div>`; });
            } catch(e){}
        }

        async function fetchHistory() {
            try {
                // Fetch Tickets
                const { data: tickets } = await supabaseClient.from('tickets').select('*').eq('requester_id', currentUser.id).order('incident_time', { ascending: false });
                if(!tickets) return;
                
                const ticketIds = tickets.map(t => t.id);
                
                // Get Assets Info
                const assetIds = [...new Set(tickets.map(t=>t.asset_id).filter(Boolean))];
                let assetMap = {};
                let assetCodeMap = {};
                if(assetIds.length) { 
                    const {data:a} = await supabaseClient.from('assets').select('id,name,asset_code').in('id',assetIds); 
                    a?.forEach(x=>{ assetMap[x.id]=x.name; assetCodeMap[x.id]=x.asset_code; }); 
                }

                // Get Media (Images) - FIX: Fetch ALL fields
                let mediaMap = {};
                if(ticketIds.length) {
                    const {data:m} = await supabaseClient.from('media').select('*').in('ticket_id', ticketIds);
                    m?.forEach(x => {
                        if(!mediaMap[x.ticket_id]) mediaMap[x.ticket_id] = [];
                        mediaMap[x.ticket_id].push(x); // Store full object
                    });
                }

                ticketsCache = tickets.map(t => ({
                    ...t,
                    asset_name: assetMap[t.asset_id]||'ไม่ระบุ',
                    asset_code: assetCodeMap[t.asset_id]||'-',
                    // Use photo_url OR first image from media
                    cover: t.photo_url || (mediaMap[t.id] && mediaMap[t.id][0] ? mediaMap[t.id][0].url : null),
                    media: mediaMap[t.id] || []
                }));

                // Check for pending inspections
                const pendingCount = ticketsCache.filter(t => t.status === 'PENDING_INSPECTION').length;
                const banner = document.getElementById('pendingInspectionBanner');
                if(pendingCount > 0) {
                    banner.classList.remove('hidden');
                    document.getElementById('pendingInspectionText').innerText = `คุณมี ${pendingCount} งานที่รอการอนุมัติ คลิกเพื่อดู`;
                } else {
                    banner.classList.add('hidden');
                }

                renderHistory(ticketsCache);
            } catch(e){ console.error(e); }
        }

        window.showPendingInspections = function() {
            openHistoryModal();
            // Auto-filter to show only PENDING_INSPECTION
            const filtered = ticketsCache.filter(t => t.status === 'PENDING_INSPECTION');
            renderHistory(filtered);
        }

        // --- ALL HISTORY MODAL FUNCTIONS ---
        let allTicketsCache = [];
        let allTicketsFiltered = [];

        window.openAllHistoryModal = async function() {
            document.getElementById('allHistoryModal').classList.remove('hidden');
            setTimeout(()=>document.getElementById('allHistoryModalContent').classList.remove('translate-y-full'),10);
            await fetchAllHistory();
        }

        window.closeAllHistoryModal = function() {
            document.getElementById('allHistoryModalContent').classList.add('translate-y-full');
            setTimeout(()=>document.getElementById('allHistoryModal').classList.add('hidden'),300);
        }

        async function fetchAllHistory() {
            try {
                // Fetch ALL Tickets (not just current user's)
                const { data: tickets } = await supabaseClient.from('tickets').select('*').order('incident_time', { ascending: false }).limit(500);
                if(!tickets) return;

                const ticketIds = tickets.map(t => t.id);

                // Get Assets Info
                const assetIds = [...new Set(tickets.map(t=>t.asset_id).filter(Boolean))];
                let assetMap = {};
                let assetCodeMap = {};
                if(assetIds.length) {
                    const {data:a} = await supabaseClient.from('assets').select('id,name,asset_code').in('id',assetIds);
                    a?.forEach(x=>{ assetMap[x.id]=x.name; assetCodeMap[x.id]=x.asset_code; });
                }

                // Get Users (Requesters & Technicians)
                const userIds = [...new Set([...tickets.map(t=>t.requester_id), ...tickets.map(t=>t.technician_id)].filter(Boolean))];
                let userMap = {};
                if(userIds.length) {
                    const {data:u} = await supabaseClient.from('profiles').select('id,full_name,username').in('id',userIds);
                    u?.forEach(x=>{ userMap[x.id] = x.full_name || x.username; });
                }

                // Get Media (Images)
                let mediaMap = {};
                if(ticketIds.length) {
                    const {data:m} = await supabaseClient.from('media').select('*').in('ticket_id', ticketIds);
                    m?.forEach(x => {
                        if(!mediaMap[x.ticket_id]) mediaMap[x.ticket_id] = [];
                        mediaMap[x.ticket_id].push(x);
                    });
                }

                allTicketsCache = tickets.map(t => ({
                    ...t,
                    asset_name: assetMap[t.asset_id]||'ไม่ระบุ',
                    asset_code: assetCodeMap[t.asset_id]||'-',
                    requester_name: userMap[t.requester_id]||'Unknown',
                    technician_name: userMap[t.technician_id]||'-',
                    cover: t.photo_url || (mediaMap[t.id] && mediaMap[t.id][0] ? mediaMap[t.id][0].url : null),
                    media: mediaMap[t.id] || []
                }));

                // Populate filter dropdowns
                populateAllHistoryFilters();
                filterAllHistory();
            } catch(e){ console.error(e); }
        }

        function populateAllHistoryFilters() {
            // Populate Asset dropdown
            const assetSelect = document.getElementById('allHistoryAsset');
            const uniqueAssets = [...new Set(allTicketsCache.map(t => t.asset_name))].filter(Boolean).sort();
            assetSelect.innerHTML = '<option value="ALL">เครื่องจักร: ทั้งหมด</option>';
            uniqueAssets.forEach(a => {
                assetSelect.innerHTML += `<option value="${a}">${a}</option>`;
            });

            // Populate Technician dropdown
            const techSelect = document.getElementById('allHistoryTech');
            const uniqueTechs = [...new Set(allTicketsCache.map(t => t.technician_name))].filter(n => n && n !== '-').sort();
            techSelect.innerHTML = '<option value="ALL">ช่าง: ทั้งหมด</option>';
            uniqueTechs.forEach(t => {
                techSelect.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        window.filterAllHistory = function() {
            const searchTerm = document.getElementById('allHistorySearch').value.toLowerCase();
            const statusFilter = document.getElementById('allHistoryStatus').value;
            const assetFilter = document.getElementById('allHistoryAsset').value;
            const techFilter = document.getElementById('allHistoryTech').value;
            const dateStart = document.getElementById('allHistoryDateStart').value;
            const dateEnd = document.getElementById('allHistoryDateEnd').value;

            allTicketsFiltered = allTicketsCache.filter(t => {
                const matchSearch = !searchTerm || t.id.toLowerCase().includes(searchTerm) || t.asset_name.toLowerCase().includes(searchTerm);
                const matchStatus = statusFilter === 'ALL' || t.status === statusFilter;
                const matchAsset = assetFilter === 'ALL' || t.asset_name === assetFilter;
                const matchTech = techFilter === 'ALL' || t.technician_name === techFilter;

                let matchDate = true;
                if(dateStart) {
                    matchDate = matchDate && dayjs(t.incident_time).isAfter(dayjs(dateStart).subtract(1, 'day'));
                }
                if(dateEnd) {
                    matchDate = matchDate && dayjs(t.incident_time).isBefore(dayjs(dateEnd).add(1, 'day'));
                }

                return matchSearch && matchStatus && matchAsset && matchTech && matchDate;
            });

            renderAllHistory(allTicketsFiltered);
        }

        window.resetAllHistoryFilters = function() {
            document.getElementById('allHistorySearch').value = '';
            document.getElementById('allHistoryStatus').value = 'ALL';
            document.getElementById('allHistoryAsset').value = 'ALL';
            document.getElementById('allHistoryTech').value = 'ALL';
            document.getElementById('allHistoryDateStart').value = '';
            document.getElementById('allHistoryDateEnd').value = '';
            filterAllHistory();
        }

        function renderAllHistory(data) {
            const list = document.getElementById('allHistoryListContainer');
            if(!data || !data.length) { list.innerHTML='<div class="text-center py-12 text-slate-400 text-sm font-medium">ไม่พบข้อมูลตามเงื่อนไข</div>'; return; }

            list.innerHTML = '<div class="mb-4 text-sm font-bold text-slate-600"><i class="fas fa-check-circle text-green-500 mr-2"></i>พบ ' + data.length + ' รายการ</div>';

            list.innerHTML += data.map((t, idx) => {
                let stClass='bg-slate-100 text-slate-600', stLabel=t.status;
                if(t.status==='OPEN') { stClass='bg-red-50 text-red-600 border border-red-100'; stLabel='รอรับงาน'; }
                if(t.status==='IN_PROGRESS') { stClass='bg-blue-50 text-blue-600 border border-blue-100'; stLabel='กำลังซ่อม'; }
                if(t.status==='PENDING_INSPECTION') { stClass='bg-purple-50 text-purple-600 border border-purple-100'; stLabel='รอตรวจสอบ'; }
                if(t.status==='CLOSED') { stClass='bg-green-50 text-green-600 border border-green-100'; stLabel='เสร็จสิ้น'; }

                let imgHtml = `<div class="w-16 h-16 rounded-lg bg-slate-100 flex items-center justify-center text-slate-300 text-2xl flex-shrink-0"><i class="fas fa-image"></i></div>`;
                if(t.cover) imgHtml = `<img src="${t.cover}" class="w-16 h-16 rounded-lg object-cover border border-slate-100 flex-shrink-0" onclick="viewImage('${t.cover}')">`;

                return `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm mb-3 relative hover:shadow-md transition">
                    <div class="flex gap-4 mb-3">
                        ${imgHtml}
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-slate-800 text-base truncate">${t.asset_name}</h4>
                                <span class="${stClass} px-2 py-0.5 rounded-lg text-[10px] font-bold whitespace-nowrap inline-block">${stLabel}</span>
                            </div>
                            <div class="text-xs text-slate-500 line-clamp-1 mb-2">${t.issue_text}</div>
                            <div class="text-[10px] text-slate-400 font-medium"><i class="far fa-clock mr-1"></i> ${Utils.formatDate(t.incident_time)}</div>
                        </div>
                    </div>
                    <div class="border-t border-slate-100 pt-3 flex items-center justify-between text-xs">
                        <div class="flex gap-3">
                            <span class="text-slate-500"><i class="fas fa-user mr-1"></i> ${t.requester_name}</span>
                            <span class="text-blue-600"><i class="fas fa-wrench mr-1"></i> ${t.technician_name}</span>
                        </div>
                        <button onclick="window.open('print_job_sheet.html?id=${t.id}','_blank')" class="text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-print text-lg"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        function showHistoryLoading() {
            const list = document.getElementById('historyListContainer');
            list.innerHTML = Array(3).fill(0).map(() => `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm mb-3">
                    <div class="flex gap-4">
                        <div class="skeleton w-16 h-16 rounded-lg flex-shrink-0"></div>
                        <div class="flex-1">
                            <div class="skeleton skeleton-title"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text" style="width: 40%;"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderHistory(data) {
            const list = document.getElementById('historyListContainer');
            if(!data || !data.length) { list.innerHTML='<div class="text-center py-12 text-slate-400 text-sm font-medium">ไม่มีข้อมูล</div>'; return; }
            list.innerHTML = data.map((t, idx) => {
                let stClass='bg-slate-100 text-slate-600', stLabel=t.status;
                if(t.status==='OPEN') { stClass='bg-red-50 text-red-600 border border-red-100'; stLabel='รอรับงาน'; }
                if(t.status==='IN_PROGRESS') { stClass='bg-blue-50 text-blue-600 border border-blue-100'; stLabel='กำลังซ่อม'; }
                if(t.status==='PENDING_INSPECTION') { stClass='bg-purple-50 text-purple-600 border border-purple-100'; stLabel='รอตรวจสอบ'; }
                if(t.status==='CLOSED') { stClass='bg-green-50 text-green-600 border border-green-100'; stLabel='เสร็จสิ้น'; }
                
                let imgHtml = `<div class="w-16 h-16 rounded-lg bg-slate-100 flex items-center justify-center text-slate-300 text-2xl flex-shrink-0"><i class="fas fa-image"></i></div>`;
                if(t.cover) imgHtml = `<img src="${t.cover}" class="w-16 h-16 rounded-lg object-cover border border-slate-100 flex-shrink-0" onclick="viewImage('${t.cover}')">`;

                return `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm mb-3 relative hover:shadow-md transition cursor-pointer" onclick="openTicketDetail(${idx})">
                    <div class="flex gap-4">
                        ${imgHtml}
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-bold text-slate-800 text-base truncate">${t.asset_name}</h4>
                                <span class="${stClass} px-2 py-0.5 rounded-lg text-[10px] font-bold whitespace-nowrap inline-block">${stLabel}</span>
                            </div>
                            <div class="text-xs text-slate-500 line-clamp-1 mb-2">${t.issue_text}</div>
                            <div class="flex justify-between items-end border-t border-slate-50 pt-2">
                                <div class="text-[10px] text-slate-400 font-medium"><i class="far fa-clock mr-1"></i> ${Utils.formatDate(t.incident_time)}</div>
                                <button onclick="event.stopPropagation(); window.open('print_job_sheet.html?id=${t.id}','_blank')" class="text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-print text-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function uploadFileToSupabase(file) {
            const fileName = `job_${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;
            const { data, error } = await supabaseClient.storage.from('repair-files').upload(fileName, file, { cacheControl: '3600', upsert: false });
            if (error) throw error;
            const { data: publicData } = supabaseClient.storage.from('repair-files').getPublicUrl(fileName);
            return publicData.publicUrl;
        }

        function renderMedia() { const z=document.getElementById('mediaDropZone'); z.innerHTML=''; mediaList.forEach((m,i)=>{ const d=document.createElement('div'); d.className='media-item'; d.innerHTML=`<img src="${m.url}"><div class="delete-btn" onclick="removeMedia(${i})">&times;</div>`; z.appendChild(d); }); document.getElementById('mediaCount').innerText=mediaList.length+'/5'; }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = Auth.requireRole(); 
            if (!currentUser) return;
            document.getElementById('userDisplayName').innerText = currentUser.full_name || currentUser.username;
            
            // Fix history state to support Android Back Button
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function () {
                if(!document.getElementById('assetModal').classList.contains('hidden')) { closeAssetModal(); window.history.pushState(null, null, window.location.href); }
                else if(!document.getElementById('historyModal').classList.contains('hidden')) { closeHistoryModal(); window.history.pushState(null, null, window.location.href); }
                else if(!document.getElementById('imageViewerModal').classList.contains('hidden')) { closeImageViewer(); window.history.pushState(null, null, window.location.href); }
                else if(!document.getElementById('scannerModal').classList.contains('hidden')) { stopScanner(); window.history.pushState(null, null, window.location.href); }
            };

            await Promise.all([fetchAssets(), fetchIssueOptions(), fetchHistory()]);
        });
    </script>
</body>
</html>