<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Board ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á (V3.2 - Realtime Alert)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    <script>
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.locale('th'); 
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        .badge { padding: 2px 8px; border-radius: 999px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .bg-OPEN { background-color: #FEE2E2; color: #DC2626; }
        .bg-IN_PROGRESS { background-color: #FEF3C7; color: #D97706; }
        .bg-PENDING_INSPECTION { background-color: #DBEAFE; color: #2563EB; }
        .bg-PENDING_APPROVAL { background-color: #F3E8FF; color: #9333EA; }
        .bg-CLOSED { background-color: #D1FAE5; color: #059669; }
        .media-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .media-scroll::-webkit-scrollbar { display: none; }

        /* Animation for New Item */
        @keyframes flash-green {
            0% { background-color: #d1fae5; transform: scale(1.02); }
            100% { background-color: white; transform: scale(1); }
        }
        .new-item-alert { animation: flash-green 2s ease-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Navbar -->
    <div class="bg-gray-800 text-white p-4 sticky top-0 z-30 shadow-lg flex justify-between items-center">
        <h1 class="font-bold text-lg"><i class="fas fa-clipboard-list mr-2"></i>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h1>
        <div class="flex gap-2 items-center">
            <!-- Sound Toggle -->
            <button onclick="toggleSound()" id="btnSound" class="text-gray-400 hover:text-white mr-2">
                <i class="fas fa-volume-mute"></i>
            </button>
            <button onclick="fetchTickets()" class="bg-gray-700 hover:bg-gray-600 w-8 h-8 rounded-full flex items-center justify-center transition">
                <i class="fas fa-sync-alt text-sm"></i>
            </button>
            <span id="connectionStatus" class="text-xs bg-red-500 px-2 py-1 rounded">Offline</span>
        </div>
    </div>

    <div class="max-w-xl mx-auto p-4 pb-20">

        <!-- Login -->
        <div id="configPanel" class="bg-white p-6 rounded-lg shadow-md mb-6 border-l-4 border-yellow-400">
            <h3 class="font-bold text-gray-800 mb-3">üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏≤‡∏á</h3>
            <input type="text" id="supaUrl" class="w-full bg-gray-50 border rounded p-2 mb-2 text-sm" placeholder="Project URL">
            <input type="password" id="supaKey" class="w-full bg-gray-50 border rounded p-2 mb-3 text-sm" placeholder="API Key">
            <button onclick="connectAndLoad()" class="w-full bg-blue-600 text-white py-2 rounded font-bold shadow hover:bg-blue-700 transition">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏á‡∏≤‡∏ô
            </button>
        </div>

        <!-- Stats -->
        <div id="statsPanel" class="hidden grid grid-cols-3 gap-3 mb-6">
            <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-red-400 text-center">
                <div class="text-2xl font-bold text-gray-800" id="countOpen">-</div>
                <div class="text-xs text-gray-500">‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°</div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-yellow-400 text-center">
                <div class="text-2xl font-bold text-gray-800" id="countProgress">-</div>
                <div class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-green-400 text-center">
                <div class="text-2xl font-bold text-gray-800" id="countDone">-</div>
                <div class="text-xs text-gray-500">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
        </div>

        <!-- Job List -->
        <div id="jobList" class="hidden space-y-4">
            <div class="text-center text-gray-400 py-10">
                <i class="fas fa-spinner fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            </div>
        </div>

    </div>

    <!-- === MODALS === -->
    <div id="finishJobModal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-green-600 p-4 text-white flex justify-between items-center flex-shrink-0">
                <h3 class="font-bold text-lg"><i class="fas fa-check-circle mr-2"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h3>
                <button onclick="closeFinishModal()" class="text-white hover:text-gray-200 text-xl">&times;</button>
            </div>
            <div class="p-5 overflow-y-auto">
                <p class="text-sm text-gray-500 mb-1">Ticket ID: <span id="finishTicketId" class="font-mono font-bold text-gray-700">...</span></p>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</label>
                    <textarea id="repairDetails" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-green-500 outline-none" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏õ‡∏∑‡∏ô‡πÉ‡∏´‡∏°‡πà..."></textarea>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-sm font-bold text-gray-700">‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏° (After):</label>
                        <span id="afterMediaCount" class="text-xs text-gray-400">0/10</span>
                    </div>
                    <div class="flex items-center gap-3 overflow-x-auto pb-2 min-h-[90px]" id="afterPhotoPreview">
                        <label class="flex-shrink-0 w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 text-gray-400 bg-white">
                            <i class="fas fa-plus text-xl"></i>
                            <input type="file" accept="image/*,video/*" multiple class="hidden" onchange="handleAfterMedia(this)">
                        </label>
                    </div>
                </div>
                <button onclick="submitFinishJob()" id="btnConfirmFinish" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-green-700 transition">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô
                </button>
            </div>
        </div>
    </div>

    <div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4" onclick="closeMediaModal()">
        <div class="relative max-w-full max-h-full">
            <img id="modalImage" class="max-w-full max-h-[80vh] rounded shadow-2xl hidden" src="">
            <video id="modalVideo" class="max-w-full max-h-[80vh] rounded shadow-2xl hidden" controls></video>
            <button class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">&times;</button>
        </div>
    </div>

    <!-- Notification Sound -->
    <audio id="soundAlert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        let supabaseClient = null;
        let currentEditingTicketId = null;
        let afterMediaList = []; 
        let isSoundOn = false;

        // 1. Connection
        async function connectAndLoad() {
            const url = document.getElementById('supaUrl').value.trim();
            const key = document.getElementById('supaKey').value.trim();
            if (!url || !key) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ Key");

            const { createClient } = supabase;
            supabaseClient = createClient(url, key);

            document.getElementById('configPanel').classList.add('hidden');
            document.getElementById('statsPanel').classList.remove('hidden');
            document.getElementById('jobList').classList.remove('hidden');
            document.getElementById('connectionStatus').innerText = "Online (Live)";
            document.getElementById('connectionStatus').className = "text-xs bg-green-500 px-2 py-1 rounded animate-pulse";

            fetchTickets();
            setupRealtimeSubscription(); // Start listening
        }

        // --- REALTIME MAGIC ---
        function setupRealtimeSubscription() {
            const channel = supabaseClient
                .channel('table-db-changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'tickets' },
                    (payload) => {
                        console.log('Change received!', payload);
                        
                        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (INSERT) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (UPDATE)
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                            fetchTickets(true); // Reload data with animation flag
                            playSound();
                        }
                    }
                )
                .subscribe();
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('btnSound');
            if(isSoundOn) {
                btn.innerHTML = '<i class="fas fa-volume-up text-green-400"></i>';
                // Try play silence to unlock audio context on mobile
                document.getElementById('soundAlert').play().catch(()=>{});
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            }
        }

        function playSound() {
            if(isSoundOn) {
                const audio = document.getElementById('soundAlert');
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio block:", e));
            }
        }

        // 2. Fetch Data
        async function fetchTickets(isUpdate = false) {
            const list = document.getElementById('jobList');
            if(!isUpdate) list.innerHTML = '<div class="text-center text-gray-400 py-10"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const { data: tickets, error } = await supabaseClient
                    .from('tickets')
                    .select(`*, assets (name, location), profiles (full_name), media (*)`)
                    .order('incident_time', { ascending: false });

                if (error) {
                    // Fallback if media table issue
                    const { data: fallback } = await supabaseClient.from('tickets').select(`*, assets (name, location), profiles (full_name)`).order('incident_time', { ascending: false });
                    renderJobs(fallback || [], isUpdate);
                    return;
                }

                renderJobs(tickets, isUpdate);
                updateStats(tickets);

            } catch (err) {
                console.error(err);
                if(!isUpdate) list.innerHTML = `<div class="bg-red-100 text-red-600 p-4 rounded text-center">Error: ${err.message}</div>`;
            }
        }

        // 3. Render Jobs
        function renderJobs(tickets, highlightNew = false) {
            const list = document.getElementById('jobList');
            list.innerHTML = '';

            if (!tickets || tickets.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏¢‡πâ! üéâ</div>`;
                return;
            }

            tickets.forEach((ticket, index) => {
                const timeAgo = dayjs(ticket.incident_time).fromNow();
                const assetName = ticket.assets?.name || 'Unknown Asset';
                const requester = ticket.profiles?.full_name || 'User';
                
                // Add highlight class if it's the first item and we are updating
                const animClass = (highlightNew && index === 0) ? 'new-item-alert' : '';

                // Media Gallery
                let allMedia = [];
                if (ticket.media && Array.isArray(ticket.media)) allMedia = [...ticket.media];
                if (ticket.photo_url && !allMedia.some(m => m.url === ticket.photo_url)) allMedia.unshift({ type: 'IMAGE', url: ticket.photo_url });

                let mediaHtml = '';
                if (allMedia.length > 0) {
                    mediaHtml = `<div class="flex gap-2 overflow-x-auto media-scroll mt-3 pb-2">`;
                    allMedia.forEach(m => {
                        const safeUrl = m.url.replace(/'/g, "\\'"); 
                        const content = m.type === 'IMAGE' 
                            ? `<img src="${m.url}" onclick="showMedia('${safeUrl}', 'IMAGE')" class="h-16 w-16 object-cover rounded-lg border border-gray-200 flex-shrink-0 cursor-pointer hover:opacity-80">`
                            : `<div onclick="showMedia('${safeUrl}', 'VIDEO')" class="h-16 w-16 bg-gray-900 rounded-lg flex items-center justify-center flex-shrink-0 cursor-pointer hover:opacity-80"><i class="fas fa-play text-white"></i></div>`;
                        mediaHtml += content;
                    });
                    mediaHtml += `</div>`;
                }

                // Reject Alert
                let rejectAlert = '';
                if (ticket.status === 'IN_PROGRESS' && ticket.reject_reason) {
                    rejectAlert = `
                        <div class="mt-3 bg-red-50 border border-red-200 rounded-lg p-3 flex items-start shadow-sm">
                            <div class="mr-3 mt-1 text-red-500"><i class="fas fa-exclamation-circle text-2xl"></i></div>
                            <div>
                                <p class="text-xs font-bold text-red-700 uppercase">‚ö†Ô∏è ‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö (Reject)</p>
                                <p class="text-sm text-red-600 font-medium mt-1">"${ticket.reject_reason}"</p>
                            </div>
                        </div>
                    `;
                }

                let actionBtn = '';
                if (ticket.status === 'OPEN') {
                    actionBtn = `<button onclick="updateStatus(this, '${ticket.id}', 'IN_PROGRESS')" class="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition flex justify-center items-center gap-2"><i class="fas fa-wrench"></i> ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πà‡∏≠‡∏°)</button>`;
                } else if (ticket.status === 'IN_PROGRESS') {
                    actionBtn = `<button onclick="openFinishModal('${ticket.id}')" class="w-full mt-3 bg-green-500 text-white py-2 rounded-lg font-bold shadow hover:bg-green-600 transition flex justify-center items-center gap-2"><i class="fas fa-check-circle"></i> ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</button>`;
                } else if (ticket.status === 'PENDING_INSPECTION') {
                    actionBtn = `<div class="mt-3 bg-blue-50 text-blue-600 p-2 rounded text-center text-sm font-bold"><i class="fas fa-clock mr-2"></i> ‡∏£‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>`;
                } else if (ticket.status === 'PENDING_APPROVAL') {
                    actionBtn = `<div class="mt-3 bg-purple-50 text-purple-600 p-2 rounded text-center text-sm font-bold"><i class="fas fa-user-tie mr-2"></i> ‡∏£‡∏≠ ‡∏ú‡∏à‡∏Å. ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>`;
                } else {
                    actionBtn = `<div class="mt-3 bg-gray-100 text-gray-500 p-2 rounded text-center text-sm"><i class="fas fa-check-double mr-2"></i> ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>`;
                }

                const card = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition relative overflow-hidden ${animClass}">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-${ticket.status}"></div>
                        <div class="pl-3">
                            <div class="flex justify-between items-start">
                                <span class="badge bg-${ticket.status}">${ticket.status.replace('_', ' ')}</span>
                                <span class="text-xs text-gray-400">${timeAgo}</span>
                            </div>
                            <h3 class="font-bold text-lg text-gray-800 mt-1">${ticket.issue_text}</h3>
                            <p class="text-sm text-gray-600"><i class="fas fa-map-marker-alt text-gray-400 mr-1"></i> ${assetName}</p>
                            <p class="text-xs text-gray-400 mt-1">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏î‡∏¢: ${requester}</p>
                            ${mediaHtml}
                            ${rejectAlert}
                            ${actionBtn}
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        }

        // 4. Update Status
        async function updateStatus(btn, id, status) {
            btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ...`;
            try {
                // Clear reject reason on start
                const updateData = { status: status, started_at: new Date().toISOString() };
                if(status === 'IN_PROGRESS') updateData.reject_reason = null; 

                const { error } = await supabaseClient.from('tickets').update(updateData).eq('id', id);
                if (error) throw error;
                // No need to fetchTickets() manually, realtime will trigger it!
            } catch (err) { alert("Error: " + err.message); btn.disabled = false; }
        }

        // ... (Finish Job & Media Handlers - same as V3.1) ...
        function openFinishModal(ticketId) {
            currentEditingTicketId = ticketId;
            afterMediaList = []; 
            document.getElementById('repairDetails').value = '';
            document.getElementById('finishTicketId').innerText = ticketId.substr(0, 8);
            updateAfterMediaPreview();
            document.getElementById('finishJobModal').classList.remove('hidden');
        }
        function closeFinishModal() { document.getElementById('finishJobModal').classList.add('hidden'); }

        async function handleAfterMedia(input) {
            if (!input.files || input.files.length === 0) return;
            if (afterMediaList.length + input.files.length > 10) return alert("‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡πÑ‡∏ü‡∏•‡πå");
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                const type = file.type.startsWith('image/') ? 'IMAGE' : 'VIDEO';
                if (type === 'VIDEO' && file.size > 20*1024*1024) continue;
                const base64 = await fileToBase64(file, type);
                if(base64) afterMediaList.push({ type, url: base64 });
            }
            input.value = ''; updateAfterMediaPreview();
        }
        function fileToBase64(file, type) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (type === 'IMAGE') {
                        const img = new Image(); img.src = e.target.result;
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            const max = 800; let w = img.width; let h = img.height;
                            if (w > max) { h *= max/w; w = max; }
                            cvs.width = w; cvs.height = h;
                            cvs.getContext("2d").drawImage(img, 0, 0, w, h);
                            resolve(cvs.toDataURL("image/jpeg", 0.7));
                        }
                    } else resolve(e.target.result);
                };
                reader.readAsDataURL(file);
            });
        }
        function updateAfterMediaPreview() {
            const container = document.getElementById('afterPhotoPreview');
            const label = container.querySelector('label');
            const countLabel = document.getElementById('afterMediaCount');
            Array.from(container.children).forEach(child => { if(child !== label) child.remove(); });
            afterMediaList.forEach((media, idx) => {
                const thumb = document.createElement('div');
                thumb.className = "flex-shrink-0 w-20 h-20 bg-gray-100 rounded-lg overflow-hidden border relative group";
                thumb.innerHTML = media.type === 'IMAGE' 
                    ? `<img src="${media.url}" class="w-full h-full object-cover">` 
                    : `<div class="w-full h-full flex items-center justify-center bg-gray-800"><i class="fas fa-video text-white"></i></div>`;
                const del = document.createElement('button');
                del.className = "absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600";
                del.innerHTML = "&times;";
                del.onclick = () => { afterMediaList.splice(idx, 1); updateAfterMediaPreview(); };
                thumb.appendChild(del);
                container.insertBefore(thumb, label);
            });
            countLabel.innerText = `${afterMediaList.length}/10`;
        }
        async function submitFinishJob() {
            const details = document.getElementById('repairDetails').value.trim();
            if (!details) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î");
            const btn = document.getElementById('btnConfirmFinish');
            btn.disabled = true; btn.innerHTML = '...';
            try {
                // Insert Log
                await supabaseClient.from('ticket_logs').insert([{
                    ticket_id: currentEditingTicketId, activity_type: 'FIX', comment: details
                }]);

                const { error } = await supabaseClient.from('tickets').update({
                    status: 'PENDING_INSPECTION', finished_at: new Date().toISOString(), repair_details: details
                }).eq('id', currentEditingTicketId);
                
                if (error) throw error;
                for (const m of afterMediaList) await supabaseClient.from('media').insert([{ ticket_id: currentEditingTicketId, type: m.type, url: m.url }]);
                alert("‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                closeFinishModal(); 
                // Realtime will auto update list
            } catch (err) { alert(err.message); } 
            finally { btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô'; btn.disabled = false; }
        }

        function updateStats(tickets) {
            document.getElementById('countOpen').innerText = tickets.filter(t => t.status === 'OPEN').length;
            document.getElementById('countProgress').innerText = tickets.filter(t => t.status === 'IN_PROGRESS').length;
            const today = new Date().toISOString().split('T')[0];
            const done = tickets.filter(t => (t.status === 'CLOSED' || t.status === 'PENDING_INSPECTION') && t.finished_at?.startsWith(today)).length;
            document.getElementById('countDone').innerText = done;
        }
        function showMedia(url, type) {
            const m = document.getElementById('mediaModal'); m.classList.remove('hidden');
            const i = document.getElementById('modalImage'); const v = document.getElementById('modalVideo');
            if (type === 'IMAGE') { i.src = url; i.classList.remove('hidden'); v.classList.add('hidden'); v.pause(); }
            else { v.src = url; v.classList.remove('hidden'); i.classList.add('hidden'); v.play(); }
        }
        function closeMediaModal() { document.getElementById('mediaModal').classList.add('hidden'); document.getElementById('modalVideo').pause(); }
    </script>
</body>
</html>